<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dashboard ‚Ä¢ KARTEJI</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --biru:#0e4c92;
  --biru2:#1a6ac2;
  --emas:#f6c445;
  --bg:#0b132b;
  --card:#111928;
  --text:#e5e7eb;
}
*{box-sizing:border-box;scroll-behavior:smooth}
body{margin:0;font-family:'Poppins',sans-serif;background:var(--bg);color:var(--text);}
header{background:linear-gradient(90deg,var(--biru),var(--biru2));padding:.8rem 1rem;display:flex;align-items:center;justify-content:space-between;box-shadow:0 4px 20px rgba(0,0,0,.3)}
.brand{display:flex;gap:.6rem;align-items:center}
.brand img{width:36px;height:36px;filter:drop-shadow(0 0 6px rgba(246,196,69,.6))}
.brand span{font-weight:700;font-size:1.1rem;background:linear-gradient(120deg,#0e4c92,#f6c445,#0e4c92);-webkit-background-clip:text;color:transparent;background-size:200%;animation:shine 4s linear infinite}
@keyframes shine{0%{background-position:0%}100%{background-position:200%}}
main{padding:1.2rem;max-width:1000px;margin:auto}
.card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.25);padding:1rem;margin-bottom:1rem}
h2{color:var(--emas);margin-top:0}
input,textarea,select{width:100%;padding:.6rem;border-radius:8px;border:1px solid #2b3a55;background:#0d1425;color:#fff;margin:.4rem 0}
button{background:var(--emas);color:#0e4c92;border:none;border-radius:8px;padding:.6rem 1rem;font-weight:700;cursor:pointer}
button:hover{background:#ffda5e}
table{width:100%;border-collapse:collapse;margin-top:.8rem}
th,td{border:1px solid rgba(255,255,255,.1);padding:.5rem;text-align:left}
th{background:#1f2a44;color:var(--emas)}
section{margin-bottom:2rem}
footer{text-align:center;opacity:.7;padding:1rem 0;border-top:1px solid rgba(255,255,255,.1)}
.hidden{display:none}
</style>
</head>
<body>

<header>
  <div class="brand">
    <img src="logo.png" alt="logo">
    <span>KARTEJI Dashboard</span>
  </div>
  <button id="logoutBtn">Keluar</button>
</header>

<main>
  <h2>Selamat datang, <span id="userEmail">...</span></h2>
  <p>Peran: <b id="userRole">...</b></p>

  <!-- SUPER ADMIN -->
  <section id="panelSuper" class="hidden">
    <div class="card">
      <h3>üëë Manajemen Anggota</h3>
      <p>Ubah role pengguna lain (anggota, admin_umkm, admin_kas, admin_berita, super_admin).</p>
      <table id="userTable"><tr><th>Email</th><th>Role</th><th>Aksi</th></tr></table>
    </div>
  </section>

  <!-- ADMIN BERITA -->
  <section id="panelBerita" class="hidden">
    <div class="card">
      <h3>üì∞ Kelola Berita</h3>
      <input id="judulBerita" placeholder="Judul berita">
      <textarea id="isiBerita" placeholder="Isi berita"></textarea>
      <input type="file" id="fotoBerita" multiple>
      <button id="btnTambahBerita">Tambah Berita</button>
      <div id="listBerita"></div>
    </div>
  </section>

  <!-- ADMIN UMKM -->
  <section id="panelUmkm" class="hidden">
    <div class="card">
      <h3>üè™ Kelola Produk UMKM</h3>
      <input id="namaProduk" placeholder="Nama Produk">
      <input id="penjual" placeholder="Nama Penjual">
      <input id="harga" placeholder="Harga">
      <input id="wa" placeholder="Nomor WA (tanpa +62)">
      <input type="file" id="fotoProduk" multiple>
      <button id="btnTambahProduk">Tambah Produk</button>
      <div id="listProduk"></div>
    </div>
  </section>

  <!-- ADMIN KAS -->
  <section id="panelKas" class="hidden">
    <div class="card">
      <h3>üí∞ Catat Transaksi Kas</h3>
      <select id="tipeKas">
        <option value="masuk">Pemasukan</option>
        <option value="keluar">Pengeluaran</option>
      </select>
      <input id="jumlahKas" type="number" placeholder="Jumlah (Rp)">
      <input id="keteranganKas" placeholder="Keterangan">
      <button id="btnTambahKas">Simpan</button>
      <div id="rekapKas"></div>
    </div>
  </section>

  <!-- ANGGOTA / WARGA -->
  <section id="panelAnggota" class="hidden">
    <div class="card">
      <h3>üë§ Profil Anggota</h3>
      <p>Email: <span id="profilEmail"></span></p>
      <p>Bergabung: <span id="profilTanggal"></span></p>
      <p>Hubungi pengurus Karang Taruna untuk ubah role.</p>
    </div>
  </section>
</main>

<footer>¬© 2025 KARTEJI ‚Ä¢ Cilosari Barat RT01/RW08</footer>

<script type="module" src="js/firebase.js"></script>
<script type="module" src="js/auth.js"></script>
<script type="module" src="js/imgbb.js"></script>

<script>
const log = console.log;
const panelSuper = document.getElementById('panelSuper');
const panelBerita= document.getElementById('panelBerita');
const panelUmkm  = document.getElementById('panelUmkm');
const panelKas   = document.getElementById('panelKas');
const panelAnggota=document.getElementById('panelAnggota');
const userEmail = document.getElementById('userEmail');
const userRole  = document.getElementById('userRole');

window.AuthAPI.onAuth(async(u)=>{
  if(!u){location.href="index.html";return;}
  userEmail.textContent=u.email;
  const { getDoc, doc, collection, getDocs, setDoc, addDoc, deleteDoc, serverTimestamp } =
    await import("https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js");
  const { db } = window.AuthAPI;
  const snap=await getDoc(doc(db,"users",u.uid));
  const data=snap.data()||{};
  const role=data.role||"anggota";
  userRole.textContent=role;
  document.getElementById('profilEmail').textContent=u.email;
  if(data.createdAt)document.getElementById('profilTanggal').textContent=new Date(data.createdAt.seconds*1000).toLocaleString();

  // tampilkan panel berdasarkan role
  if(role==="super_admin")panelSuper.classList.remove('hidden');
  if(["super_admin","admin_berita"].includes(role))panelBerita.classList.remove('hidden');
  if(["super_admin","admin_umkm"].includes(role))panelUmkm.classList.remove('hidden');
  if(["super_admin","admin_kas"].includes(role))panelKas.classList.remove('hidden');
  panelAnggota.classList.remove('hidden');

  // ==== SUPER ADMIN ====
  if(role==="super_admin"){
    const t=document.getElementById('userTable');
    const us=await getDocs(collection(db,"users"));
    us.forEach(d=>{
      const v=d.data();
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${v.email}</td><td>${v.role}</td>
      <td>
        <select data-id="${d.id}">
          <option ${v.role==="anggota"?"selected":""}>anggota</option>
          <option ${v.role==="admin_umkm"?"selected":""}>admin_umkm</option>
          <option ${v.role==="admin_kas"?"selected":""}>admin_kas</option>
          <option ${v.role==="admin_berita"?"selected":""}>admin_berita</option>
          <option ${v.role==="super_admin"?"selected":""}>super_admin</option>
        </select>
      </td>`;
      t.appendChild(tr);
    });
    t.onchange=async(e)=>{
      if(e.target.tagName!=="SELECT")return;
      await setDoc(doc(db,"users",e.target.dataset.id),{role:e.target.value},{merge:true});
      alert("Role diperbarui!");
    };
  }

  // ==== ADMIN BERITA ====
  if(["super_admin","admin_berita"].includes(role)){
    document.getElementById('btnTambahBerita').onclick=async()=>{
      const judul=document.getElementById('judulBerita').value;
      const isi=document.getElementById('isiBerita').value;
      const files=document.getElementById('fotoBerita').files;
      const urls=[];
      for(const f of files){
        const url=await window.__IMGBB__.uploadToImgBB(f);
        urls.push(url);
      }
      await addDoc(collection(db,"berita"),{judul,isi,foto:urls,createdAt:serverTimestamp()});
      alert("Berita disimpan!");
      location.reload();
    };
  }

  // ==== ADMIN UMKM ====
  if(["super_admin","admin_umkm"].includes(role)){
    document.getElementById('btnTambahProduk').onclick=async()=>{
      const produk=document.getElementById('namaProduk').value;
      const penjual=document.getElementById('penjual').value;
      const harga=Number(document.getElementById('harga').value);
      const wa=document.getElementById('wa').value;
      const files=document.getElementById('fotoProduk').files;
      const urls=[];
      for(const f of files){
        const url=await window.__IMGBB__.uploadToImgBB(f);
        urls.push(url);
      }
      await addDoc(collection(db,"umkm"),{produk,penjual,harga,wa,foto:urls,createdAt:serverTimestamp()});
      alert("Produk ditambahkan!");
      location.reload();
    };
  }

  // ==== ADMIN KAS ====
  if(["super_admin","admin_kas"].includes(role)){
    const btn=document.getElementById('btnTambahKas');
    btn.onclick=async()=>{
      const tipe=document.getElementById('tipeKas').value;
      const jumlah=Number(document.getElementById('jumlahKas').value);
      const ket=document.getElementById('keteranganKas').value;
      await addDoc(collection(db,"kas"),{tipe,jumlah,keterangan:ket,createdAt:serverTimestamp()});
      alert("Transaksi disimpan");
      location.reload();
    };
    const list=document.getElementById('rekapKas');
    const ks=await getDocs(collection(db,"kas"));
    let total=0;
    let html="<table><tr><th>Tipe</th><th>Jumlah</th><th>Keterangan</th></tr>";
    ks.forEach(d=>{
      const v=d.data();
      total+=(v.tipe==="masuk"?1:-1)*(v.jumlah||0);
      html+=`<tr><td>${v.tipe}</td><td>Rp${(v.jumlah||0).toLocaleString()}</td><td>${v.keterangan||''}</td></tr>`;
    });
    html+=`</table><p><b>Total: Rp ${total.toLocaleString()}</b></p>`;
    list.innerHTML=html;
  }
});

// tombol logout
document.getElementById('logoutBtn').onclick=async()=>{await window.AuthAPI.logout();location.href="index.html";};
</script>

</body>
</html>