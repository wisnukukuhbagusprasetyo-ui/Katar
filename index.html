<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Portal Karang Taruna Cilosari Barat RT01/RW08</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="./style.css">
<style>
.prewrap { white-space: pre-wrap; word-wrap: break-word; line-height: 1.6; }
#detailModal {
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);
  z-index:999;justify-content:center;align-items:center;
}
.detail-box {
  background:var(--card);color:var(--text);border-radius:12px;
  max-width:700px;width:90%;padding:1.5rem;box-shadow:0 0 20px rgba(0,0,0,0.5);
  position:relative;backdrop-filter:blur(10px);
}
#closeDetail {position:absolute;top:8px;right:12px;cursor:pointer;font-weight:700;color:var(--gold);}
#closeDetail:hover {color:#fff;}
.thumb-mini{width:100%;height:160px;object-fit:cover;border-radius:8px;margin-bottom:.5rem;}
</style>
</head>

<body>
<header>
  <h1>🌌 Karang Taruna Cilosari Barat</h1>
  <button id="themeToggle">🌙</button>
</header>

<section class="hero" style="text-align:center;padding:3rem 1rem 2rem;">
  <h2 id="heroText" style="font-size:2rem;font-weight:800;color:var(--gold);"></h2>
  <p style="max-width:600px;margin:auto;color:var(--muted)">
    Portal digital <b>Karang Taruna RT01/RW08 Kel. Kemijen</b> – pusat informasi kegiatan, kolaborasi, dan semangat warga muda Semarang Timur.
  </p>
  <div style="margin-top:2rem;">
    <a href="#agenda" class="btn btn-primary">Agenda Bulan Ini</a>
    <a href="#berita" class="btn btn-ghost">Berita</a>
  </div>
</section>

<section id="pengumuman" style="padding:1rem 0;background:rgba(255,255,255,0.05);border-top:1px solid var(--border);border-bottom:1px solid var(--border);">
  <marquee id="marqueeText" behavior="scroll" direction="left" scrollamount="5" style="color:var(--gold);font-weight:600;">
    📢 Memuat pengumuman terbaru...
  </marquee>
</section>

<section class="container" style="text-align:center;margin-top:2rem;">
  <div class="grid grid-3">
    <div class="card">
      <h3>💰 Ringkasan Kas</h3>
      <p>Total Kas Saat Ini:</p>
      <h1 id="kasTotal">Rp 0</h1>
    </div>
    <div class="card">
      <h3>🌤️ Cuaca Hari Ini</h3>
      <p id="weather" class="muted">Memuat...</p>
    </div>
    <div class="card">
      <h3>🕌 Waktu Sholat</h3>
      <div id="prayTimes" class="muted"></div>
    </div>
  </div>
</section>

<!-- PENGUMUMAN -->
<section id="pengumumanListSection" class="container" style="margin-top:3rem;">
  <h2>📢 Pengumuman Terbaru</h2>
  <div id="pengumumanList" class="grid grid-2"></div>
</section>

<!-- AGENDA -->
<section id="agenda" class="container" style="margin-top:3rem;">
  <h2>📅 Agenda / Kegiatan Bulan Ini</h2>
  <div id="agendaList" class="grid grid-2"></div>
</section>

<!-- BERITA -->
<section id="berita" class="container" style="margin-top:3rem;">
  <h2>📰 Berita Terkini</h2>
  <div id="beritaList" class="grid grid-2"></div>
</section>

<!-- UMKM -->
<section id="umkm" class="container" style="margin-top:3rem;">
  <h2>🏪 Produk UMKM</h2>
  <input type="text" id="searchUmkm" placeholder="Cari produk..." style="max-width:300px;margin-bottom:1rem;">
  <div id="umkmList" class="grid grid-3"></div>
</section>

<!-- CTA LOGIN -->
<section id="ctaLogin" style="text-align:center;margin:3rem 0;">
  <h2>🔑 Masuk ke Portal</h2>
  <p>Gabung sebagai anggota Karang Taruna untuk mengakses fitur internal seperti kas, agenda, dan pengelolaan konten.</p>
  <button class="btn btn-primary" id="openLogin">Masuk / Daftar</button>
</section>

<footer style="text-align:center;padding:1.2rem;background:var(--violet-dark);color:#fff;">
  <p>&copy; 2025 Karang Taruna Cilosari Barat RT01/RW08 – Semarang Timur</p>
</footer>

<!-- MODAL DETAIL -->
<div id="detailModal">
  <div class="detail-box">
    <span id="closeDetail">✕</span>
    <h2 id="detailTitle"></h2>
    <p id="detailBody" class="prewrap"></p>
  </div>
</div>

<!-- MODAL LOGIN -->
<div id="authModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:999;justify-content:center;align-items:center;">
  <div class="card" style="max-width:400px;width:90%;text-align:center;position:relative;">
    <span id="closeModal" style="position:absolute;top:8px;right:12px;cursor:pointer;font-weight:700;">✕</span>
    <h3>Masuk / Daftar</h3>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Kata Sandi">
    <button id="loginBtn" class="btn btn-primary">Masuk</button>
    <button id="registerBtn" class="btn btn-ghost" style="margin-top:.5rem;">Daftar</button>
    <small><a href="#" id="forgotPassword" style="color:var(--gold);text-decoration:none;">Lupa kata sandi?</a></small>
  </div>
</div>

<script type="module">
import { db, auth } from "./js/firebase.js";
import {
  signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail
} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
import { collection, getDocs, orderBy, query } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

/* HERO typing */
const heroText=document.getElementById("heroText");
const textSeq=["Portal Karang Taruna","Wadah Kolaborasi","Semangat Pemuda!"];
let idx=0;
function typing(){let i=0,t=textSeq[idx];heroText.textContent="";
const s=setInterval(()=>{heroText.textContent+=t[i];i++;if(i===t.length){clearInterval(s);setTimeout(()=>{idx=(idx+1)%textSeq.length;typing();},1800);}},100);}
typing();

/* Modal detail */
const modal=document.getElementById("detailModal"),closeDetail=document.getElementById("closeDetail");
closeDetail.onclick=()=>modal.style.display="none";
window.onclick=(e)=>{if(e.target===modal)modal.style.display="none";}
function showDetail(title,body){document.getElementById("detailTitle").textContent=title;document.getElementById("detailBody").textContent=body;modal.style.display="flex";}

/* Modal login */
const authModal=document.getElementById("authModal");
document.getElementById("openLogin").onclick=()=>authModal.style.display="flex";
document.getElementById("closeModal").onclick=()=>authModal.style.display="none";
window.addEventListener("click",(e)=>{if(e.target===authModal)authModal.style.display="none";});

/* Auth */
document.getElementById("loginBtn").onclick=async()=>{
  const email=document.getElementById("email").value,pass=document.getElementById("password").value;
  try{await signInWithEmailAndPassword(auth,email,pass);location.href="./dashboard.html";}
  catch(e){alert("Login gagal: "+e.message);}
};
document.getElementById("registerBtn").onclick=async()=>{
  const email=document.getElementById("email").value,pass=document.getElementById("password").value;
  try{await createUserWithEmailAndPassword(auth,email,pass);alert("Pendaftaran berhasil!");authModal.style.display="none";}
  catch(e){alert("Gagal daftar: "+e.message);}
};
document.getElementById("forgotPassword").onclick=async(e)=>{
  e.preventDefault();const email=document.getElementById("email").value;
  if(!email)return alert("Masukkan email untuk reset.");
  try{await sendPasswordResetEmail(auth,email);alert("Link reset dikirim.");}
  catch(e){alert("Gagal: "+e.message);}
};

/* FIRESTORE LOAD */
async function loadPengumuman(){
  const c=document.getElementById("pengumumanList"),snap=await getDocs(query(collection(db,"pengumuman"),orderBy("createdAt","desc")));
  c.innerHTML="";let txt="";
  snap.forEach(d=>{const p=d.data();const el=document.createElement("div");
    el.className="card";
    el.innerHTML=`<h3>${p.judul||"Tanpa Judul"}</h3><p class='prewrap'>${(p.isi||"").slice(0,120)}...</p>
    <button class='btn btn-primary' onclick='showDetail(${JSON.stringify(p.judul)},${JSON.stringify(p.isi)})'>Selengkapnya</button>`;
    c.appendChild(el);txt+=`📢 ${p.judul} &nbsp;&nbsp;`;
  });
  document.getElementById("marqueeText").innerHTML=txt||"Belum ada pengumuman.";
}
loadPengumuman();

async function loadAgenda(){
  const c=document.getElementById("agendaList"),snap=await getDocs(query(collection(db,"agenda"),orderBy("tanggal","asc")));
  c.innerHTML="";
  const now=new Date(),month=now.getMonth()+1,year=now.getFullYear();
  snap.forEach(d=>{
    const a=d.data(),tgl=new Date(a.tanggal);
    if(tgl.getMonth()+1===month && tgl.getFullYear()===year){
      const el=document.createElement("div");el.className="card";
      el.innerHTML=`
        ${a.poster?`<img src='${a.poster}' class='thumb-mini'>`:""}
        <h3>${a.nama||"Kegiatan"}</h3>
        <p>📅 ${a.tanggal||"-"}<br>📍 ${a.lokasi||"-"}</p>
        <button class='btn btn-primary' onclick='showDetail(${JSON.stringify(a.nama)},${JSON.stringify(a.deskripsi||"")})'>Selengkapnya</button>`;
      c.appendChild(el);
    }
  });
}
loadAgenda();

async function loadBerita(){
  const c=document.getElementById("beritaList"),snap=await getDocs(query(collection(db,"berita"),orderBy("createdAt","desc")));
  c.innerHTML="";
  snap.forEach(d=>{const b=d.data(),el=document.createElement("div");el.className="card";
    el.innerHTML=`${b.foto?`<img class='thumb-mini' src='${b.foto}'>`:""}<h3>${b.judul||"Tanpa Judul"}</h3>
    <p class='prewrap'>${(b.isi||"").slice(0,150)}...</p>
    <button class='btn btn-primary' onclick='showDetail(${JSON.stringify(b.judul)},${JSON.stringify(b.isi)})'>Selengkapnya</button>`;
    c.appendChild(el);
  });
}
loadBerita();

async function loadUmkm(){
  const c=document.getElementById("umkmList"),snap=await getDocs(query(collection(db,"umkm"),orderBy("createdAt","desc")));
  c.innerHTML="";
  snap.forEach(d=>{const u=d.data(),el=document.createElement("div");el.className="card";
    el.innerHTML=`${u.foto?`<img class='thumb-mini' src='${u.foto}'>`:""}<h3>${u.produk||"Produk"}</h3>
    <p>👤 ${u.penjual||"-"}<br>💰 Rp${(u.harga||0).toLocaleString()}</p>
    ${u.wa?`<a href='https://wa.me/${u.wa}' target='_blank' class='btn btn-ghost'>Hubungi</a>`:""}`;
    c.appendChild(el);
  });
}
loadUmkm();

async function loadWeather(){
  try{
    const r=await fetch("https://api.open-meteo.com/v1/forecast?latitude=-6.97&longitude=110.42&current_weather=true");
    const w=(await r.json()).current_weather;
    document.getElementById("weather").textContent=`${w.temperature}°C, Angin ${w.windspeed} km/j`;
  }catch{document.getElementById("weather").textContent="Gagal memuat cuaca";}
}
loadWeather();

async function loadPrayer(){
  try{
    const r=await fetch("https://api.aladhan.com/v1/timingsByCity?city=Semarang&country=Indonesia&method=2");
    const t=(await r.json()).data.timings;
    document.getElementById("prayTimes").innerHTML=`Fajr: ${t.Fajr}<br>Dhuhr: ${t.Dhuhr}<br>Asr: ${t.Asr}<br>Maghrib: ${t.Maghrib}<br>Isha: ${t.Isha}`;
  }catch{document.getElementById("prayTimes").textContent="Gagal memuat waktu sholat";}
}
loadPrayer();

async function loadKas(){
  try{
    const snap=await getDocs(collection(db,"kas"));
    let total=0;snap.forEach(d=>{const k=d.data();total+=k.tipe==="masuk"?k.jumlah:-k.jumlah;});
    document.getElementById("kasTotal").textContent="Rp "+total.toLocaleString();
  }catch{document.getElementById("kasTotal").textContent="Rp 0";}
}
loadKas();

/* THEME */
const tbtn=document.getElementById("themeToggle"),root=document.documentElement;
if(localStorage.getItem("theme")==="dark"){root.setAttribute("data-theme","dark");tbtn.textContent="☀️";}
tbtn.onclick=()=>{const d=root.getAttribute("data-theme")==="dark";
  if(d){root.removeAttribute("data-theme");localStorage.setItem("theme","light");tbtn.textContent="🌙";}
  else{root.setAttribute("data-theme","dark");localStorage.setItem("theme","dark");tbtn.textContent="☀️";}
};
</script>
</body>
</html>