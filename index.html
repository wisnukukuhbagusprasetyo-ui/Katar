<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Karang Taruna Cilosari Barat RT01/RW08</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --biru:#0e4c92;--emas:#f6c445;--gelap:#1e293b;--abu:#f5f7fa;--putih:#fff;
}
[data-theme='dark']{
  --biru:#1a73e8;--gelap:#e2e8f0;--abu:#0f172a;--putih:#1e293b;
}
*{box-sizing:border-box;transition:background .3s,color .3s;}
body{margin:0;font-family:'Poppins',sans-serif;background:var(--abu);color:var(--gelap);}
header{background:linear-gradient(90deg,var(--biru),#1a6ac2);color:#fff;padding:.8rem 1.2rem;
display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:999;}
header h1{margin:0;font-size:1rem;}
nav a,nav button{color:#fff;text-decoration:none;font-weight:600;background:none;border:none;cursor:pointer;font-family:'Poppins',sans-serif;}
nav a:hover,nav button:hover{color:var(--emas);}
#themeToggle{background:var(--emas);color:var(--biru);border:none;border-radius:20px;padding:.3rem .8rem;cursor:pointer;font-weight:600;}
nav.desktop{display:flex;gap:1rem;align-items:center;}
.hamburger{display:none;flex-direction:column;cursor:pointer;gap:5px;}
.hamburger div{width:25px;height:3px;background:#fff;border-radius:2px;transition:.3s;}
nav.mobile{display:none;flex-direction:column;background:var(--biru);width:100%;text-align:center;padding:1rem 0;}
nav.mobile a{padding:.6rem 0;border-bottom:1px solid rgba(255,255,255,.2);}
.show{display:flex!important;}
.hero{background:linear-gradient(180deg,var(--biru),#155fa3);color:#fff;text-align:center;padding:3rem 1rem;border-bottom:4px solid var(--emas);}
.hero h2{font-size:1.8rem;margin:0 0 .5rem;}
.container{max-width:1100px;margin:auto;padding:1rem;}
.section-title{font-size:1.3rem;color:var(--biru);border-left:5px solid var(--emas);padding-left:.6rem;margin-bottom:1.2rem;}
.grid{display:grid;gap:1.2rem;}
@media(min-width:600px){.grid-2{grid-template-columns:repeat(2,1fr)}}
@media(min-width:900px){.grid-3{grid-template-columns:repeat(3,1fr)}}
.card{background:var(--putih);border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.08);overflow:hidden;transition:transform .2s,box-shadow .3s;}
.card:hover{transform:translateY(-5px);box-shadow:0 4px 12px rgba(0,0,0,0.15);}
.card img{width:100%;height:180px;object-fit:cover;}
.card-content{padding:1rem;}
.card h3,.card h4{color:var(--biru);margin:.4rem 0;}
.btn{background:var(--biru);color:#fff;border:none;border-radius:6px;padding:.5rem .8rem;cursor:pointer;font-weight:600;text-decoration:none;margin-top:.4rem;font-size:.9rem;display:inline-block;}
.btn:hover{background:var(--emas);color:var(--biru);}
.pengumuman-box{background:#e9f2ff;border-left:5px solid var(--biru);border-radius:8px;padding:1rem 1.2rem;box-shadow:0 2px 8px rgba(0,0,0,.05);}
.pengumuman-item{margin-bottom:.8rem;padding-bottom:.8rem;border-bottom:1px dashed rgba(0,0,0,0.1);}
footer{background:var(--biru);color:#fff;text-align:center;padding:1rem;margin-top:2rem;font-size:.9rem;}
#authModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:1000;justify-content:center;align-items:center;}
.auth-box{background:var(--putih);border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.2);max-width:380px;width:90%;padding:1.5rem;position:relative;}
.auth-box input{width:100%;padding:.6rem;margin-bottom:.7rem;border:1px solid #ccc;border-radius:6px;}
.auth-box button{width:100%;padding:.6rem;font-weight:600;border:none;border-radius:6px;background:var(--biru);color:#fff;cursor:pointer;}
.auth-box button:hover{background:var(--emas);color:var(--biru);}
#closeModal{position:absolute;top:8px;right:12px;cursor:pointer;font-size:1.3rem;color:#555;}
@media(max-width:700px){.hamburger{display:flex;}nav.desktop{display:none;}}
</style>
</head>
<body>
<header>
  <h1>Karang Taruna Cilosari Barat</h1>
  <div class="hamburger" id="hamburger"><div></div><div></div><div></div></div>
  <nav class="desktop">
    <a href="#pengumuman">Pengumuman</a>
    <a href="#berita">Berita</a>
    <a href="#umkm">UMKM</a>
    <a href="#kasSection">Kas</a>
    <a id="navAdmin" href="./admin.html" style="display:none;">Admin</a>
    <div id="navAuth"></div>
    <button id="themeToggle">üåô</button>
  </nav>
</header>

<nav class="mobile" id="mobileNav">
  <a href="#pengumuman">Pengumuman</a>
  <a href="#berita">Berita</a>
  <a href="#umkm">UMKM</a>
  <a href="#kasSection">Kas</a>
  <a id="navAdminMobile" href="./admin.html" style="display:none;">Admin</a>
  <a href="#" id="openLogin">Masuk / Daftar</a>
  <div id="navAuthMobile"></div>
</nav>

<section class="hero">
  <h2>Selamat Datang di Portal Karang Taruna</h2>
  <p>Informasi kegiatan, berita warga, pengumuman, kas dan UMKM RT01/RW08 Kelurahan Kemijen, Semarang Timur.</p>
</section>

<section id="pengumuman">
  <div class="container">
    <h2 class="section-title">üì¢ Pengumuman Warga</h2>
    <div id="pengumumanList" class="pengumuman-box"></div>
  </div>
</section>

<main class="container">
  <section id="berita">
    <h2 class="section-title">üì∞ Berita Terkini</h2>
    <div id="beritaList" class="grid grid-2"></div>
  </section>

  <section id="umkm">
    <h2 class="section-title">üè™ UMKM Warga</h2>
    <input id="searchUmkm" placeholder="Cari UMKM..." style="padding:.5rem;border-radius:6px;border:1px solid #ccc;width:100%;max-width:300px;margin-bottom:1rem;">
    <div id="umkmList" class="grid grid-3"></div>
  </section>

  <section id="kasSection" style="display:none;">
    <h2 class="section-title">üí∞ Informasi Kas Karang Taruna</h2>
    <div id="kasBox" class="card" style="max-width:640px;margin:auto;text-align:center;">
      <h3>Total Kas Saat Ini</h3>
      <h1 id="kasTotal">Rp 0</h1>
      <div id="kasList" style="text-align:left;margin-top:1rem;"></div>
    </div>
  </section>
</main>

<footer><p>&copy; 2025 Karang Taruna Cilosari Barat RT01/RW08 - Semarang Timur</p></footer>

<!-- MODAL LOGIN -->
<div id="authModal">
  <div class="auth-box">
    <span id="closeModal">‚úï</span>
    <h3 id="authTitle">Masuk / Daftar</h3>
    <input id="email" type="email" placeholder="Email">
    <input id="password" type="password" placeholder="Kata Sandi">
    <button id="loginBtn">Masuk</button>
    <button id="registerBtn" style="background:var(--emas);color:var(--biru);margin-top:.5rem;">Daftar</button>
  </div>
</div>

<script type="module">
import { db, auth } from "./js/firebase.js";
import { registerUser, loginUser } from "./js/auth.js";
import {
  onAuthStateChanged, signOut
} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
import { doc, getDoc, collection, getDocs, query, orderBy } 
  from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

/* ===== NAV & THEME ===== */
const hamburger=document.getElementById("hamburger"), mobileNav=document.getElementById("mobileNav");
hamburger.onclick=()=>mobileNav.classList.toggle("show");
const themeToggle=document.getElementById("themeToggle");
if(localStorage.getItem("theme")==="dark"){document.documentElement.setAttribute("data-theme","dark");themeToggle.textContent="‚òÄÔ∏è";}
themeToggle.onclick=()=>{if(document.documentElement.getAttribute("data-theme")==="dark"){document.documentElement.removeAttribute("data-theme");localStorage.setItem("theme","light");themeToggle.textContent="üåô";}else{document.documentElement.setAttribute("data-theme","dark");localStorage.setItem("theme","dark");themeToggle.textContent="‚òÄÔ∏è";}};

/* ===== MODAL LOGIN ===== */
const authModal=document.getElementById("authModal");
document.getElementById("openLogin").onclick=(e)=>{e.preventDefault();authModal.style.display="flex";};
document.getElementById("closeModal").onclick=()=>authModal.style.display="none";
window.addEventListener("click",(e)=>{if(e.target===authModal)authModal.style.display="none";});

/* ===== AUTH STATE ===== */
const navAuth=document.getElementById("navAuth"),navAdmin=document.getElementById("navAdmin"),
navAuthMobile=document.getElementById("navAuthMobile"),navAdminMobile=document.getElementById("navAdminMobile"),
kasSection=document.getElementById("kasSection");

onAuthStateChanged(auth, async(user)=>{
  if(user){
    const snap = await getDoc(doc(db,"users",user.uid));
    const role = snap.exists() ? snap.data().role : "anggota";
    const profileHTML = `<span class="profile-name">üë§ ${user.email.split('@')[0]}</span> <button id="logoutBtn">Keluar</button>`;
    navAuth.innerHTML=profileHTML; navAuthMobile.innerHTML=profileHTML;
    document.querySelectorAll("#logoutBtn").forEach(b=>b.onclick=async()=>await signOut(auth));
    if(["admin","super_admin"].includes(role)){navAdmin.style.display="inline-block";navAdminMobile.style.display="block";}
    else{navAdmin.style.display="none";navAdminMobile.style.display="none";}
    kasSection.style.display="block"; loadKas();
  }else{
    navAuth.innerHTML="";navAuthMobile.innerHTML="";navAdmin.style.display="none";navAdminMobile.style.display="none";
    kasSection.style.display="none";
  }
});

/* ===== LOGIN / REGISTER ===== */
document.getElementById("loginBtn").onclick=async()=>{
  const email=document.getElementById("email").value.trim(),pass=document.getElementById("password").value;
  if(!email||!pass)return alert("Isi email & password");
  await loginUser(email,pass);
  authModal.style.display="none";
};
document.getElementById("registerBtn").onclick=async()=>{
  const email=document.getElementById("email").value.trim(),pass=document.getElementById("password").value;
  if(!email||!pass)return alert("Isi email & password");
  await registerUser(email,pass);
  authModal.style.display="none";
};

/* ===== PENGUMUMAN ===== */
async function loadPengumuman(){
  const pengumumanList=document.getElementById("pengumumanList");
  try{
    const snap=await getDocs(query(collection(db,"pengumuman"),orderBy("createdAt","desc")));
    pengumumanList.innerHTML="";
    if(snap.empty){pengumumanList.innerHTML="<p>Tidak ada pengumuman.</p>";return;}
    snap.forEach(d=>{
      const p=d.data();
      pengumumanList.innerHTML+=`<div class='pengumuman-item'><h4>üì¢ ${p.judul||"Tanpa Judul"}</h4><p>${p.isi||""}</p><small>${p.tanggal||""}</small></div>`;
    });
  }catch{pengumumanList.innerHTML="<p style='color:red'>Gagal memuat pengumuman.</p>";}
}
loadPengumuman();

/* ===== BERITA ===== */
async function loadBerita(){
  const beritaList=document.getElementById("beritaList");
  try{
    const snap=await getDocs(query(collection(db,"berita"),orderBy("createdAt","desc")));
    beritaList.innerHTML="";
    if(snap.empty){beritaList.innerHTML="<p>Belum ada berita.</p>";return;}
    snap.forEach(d=>{
      const b=d.data();
      const ringkas=(b.isi||"").length>180?(b.isi||"").slice(0,180)+"...":(b.isi||"");
      beritaList.innerHTML+=`<div class='card'>${b.foto?`<img src='${b.foto}'/>`:""}<div class='card-content'><h3>${b.judul}</h3><p>${ringkas}</p></div></div>`;
    });
  }catch{beritaList.innerHTML="<p style='color:red'>Gagal memuat berita.</p>";}
}
loadBerita();

/* ===== UMKM ===== */
let allUmkm=[];
async function loadUmkm(){
  const umkmList=document.getElementById("umkmList");
  try{
    const snap=await getDocs(query(collection(db,"umkm"),orderBy("createdAt","desc")));
    allUmkm=[];snap.forEach(d=>allUmkm.push(d.data()));
    renderUmkm(allUmkm);
  }catch{umkmList.innerHTML="<p style='color:red'>Gagal memuat UMKM.</p>";}
}
function renderUmkm(list){
  const el=document.getElementById("umkmList");
  el.innerHTML="";
  if(list.length===0){el.innerHTML="<p>Belum ada UMKM.</p>";return;}
  list.forEach(u=>{
    el.innerHTML+=`<div class='card'>${u.foto?`<img src='${u.foto}'/>`:""}<div class='card-content'><h4>${u.nama}</h4><p>üí∞ Rp${(u.harga||0).toLocaleString()}</p><p>${u.deskripsi||""}</p>${u.wa?`<a href='https://wa.me/${u.wa}' class='btn'>Hubungi</a>`:""}</div></div>`;
  });
}
document.getElementById("searchUmkm").oninput=(e)=>{
  const key=e.target.value.toLowerCase();
  renderUmkm(allUmkm.filter(u=>(u.nama||"").toLowerCase().includes(key)||(u.deskripsi||"").toLowerCase().includes(key)));
};
loadUmkm();

/* ===== KAS ===== */
async function loadKas(){
  const kasTotal=document.getElementById("kasTotal"),kasList=document.getElementById("kasList");
  try{
    const snap=await getDocs(query(collection(db,"kas"),orderBy("createdAt","desc")));
    let total=0;let html="";
    snap.forEach(d=>{
      const k=d.data();const val=k.jenis==="masuk"?k.nominal:-k.nominal;
      total+=val;
      html+=`<p>${k.tanggal||""} - ${k.keterangan||""}<br><strong style='color:${k.jenis==="masuk"?"green":"red"};'>${k.jenis==="masuk"?"+":"-"} Rp${(k.nominal||0).toLocaleString()}</strong></p>`;
    });
    kasTotal.textContent="Rp "+total.toLocaleString();
    kasList.innerHTML=html||"<p>Belum ada transaksi kas.</p>";
  }catch{kasList.innerHTML="<p style='color:red'>Gagal memuat kas.</p>";}
}
</script>
</body>
</html>