<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Karang Taruna Cilosari Barat â€¢ v7.3 iOS26</title>
  <link rel="stylesheet" href="./css/style.css">
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#000000">
  <link rel="apple-touch-icon" href="./assets/icons/icon-192.png">
  <style>
    .list-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media(max-width:768px){.list-grid{grid-template-columns:1fr}}
    .item-card{border:1px solid rgba(255,255,255,.15);border-radius:14px;padding:10px;background:rgba(255,255,255,.04);backdrop-filter:blur(12px)}
    .item-img{width:100%;height:140px;object-fit:cover;border-radius:10px;background:rgba(255,255,255,.06)}
    .item-title{margin:.5rem 0 .25rem;font-weight:600}
    .item-meta{font-size:.85rem;opacity:.75}
    .private{display:none}.logged-in .private{display:block}
  </style>
</head>
<body>
  <header class="header-glass">
    <div class="header-title">
      <img id="logoImg" class="logo-glow" src="./assets/icons/kt.svg" alt="KT">
      <div>
        <div id="portalName">Karang Taruna Cilosari Barat</div>
        <small class="info-chip">ğŸ•’ <span id="clock">--:--</span> WIB</small>
      </div>
    </div>
    <a class="info-chip" href="./auth/portal.html">ğŸ” Masuk</a>
  </header>

  <main class="container">
    <section class="grid">
      <div class="card-glass span-3 clickable" onclick="location.href='./pages/kas.html'"><p class="card-title">ğŸ’° Kas & Iuran</p><p class="card-value">Rp 0</p></div>
      <div class="card-glass span-3 clickable" onclick="location.href='./pages/kegiatan.html'"><p class="card-title">ğŸ“… Kegiatan</p><p class="card-value">0</p></div>
      <div class="card-glass span-3 clickable" onclick="location.href='./pages/anggota.html'"><p class="card-title">ğŸ‘¥ Anggota</p><p class="card-value">0</p></div>
      <div class="card-glass span-3 clickable private" onclick="location.href='./pages/forum.html'"><p class="card-title">ğŸ’¬ Forum Internal</p><p class="card-value">Masuk</p></div>
    </section>

    <section class="grid" style="margin-top:14px">
      <div class="card-glass span-12">
        <p class="card-title">ğŸ“¢ Berita Terbaru</p>
        <div id="beritaList" class="list-grid"><div class="info-chip">Memuat beritaâ€¦</div></div>
        <div style="margin-top:10px;text-align:right"><a class="info-chip" href="./pages/berita.html">Lihat semua berita âœ</a></div>
      </div>
    </section>

    <section class="grid" style="margin-top:14px">
      <div class="card-glass span-12">
        <p class="card-title">ğŸª UMKM Unggulan</p>
        <div id="umkmList" class="list-grid"><div class="info-chip">Memuat UMKMâ€¦</div></div>
        <div style="margin-top:10px;text-align:right"><a class="info-chip" href="./pages/umkm.html">Lihat semua UMKM âœ</a></div>
      </div>
    </section>

    <section class="grid" style="margin-top:14px">
      <div class="card-glass span-8"><p class="card-title">Agenda Terdekat</p><div id="agendaBox" class="info-chip">Belum ada agenda publik.</div></div>
      <div class="card-glass span-4"><p class="card-title">Notifikasi</p><div id="notifBox" class="info-chip">Tidak ada notifikasi.</div></div>
    </section>

    <p class="footer-note">v7.3 â€¢ Single Unit â€¢ iOS26 Theme â€¢ PWA</p>
  </main>

  <nav class="nav-float">
    <a class="active" href="./index.html" title="Beranda">ğŸ </a>
    <a href="./pages/kegiatan.html" title="Kegiatan">ğŸ“…</a>
    <a href="./pages/forum.html" title="Forum" class="private">ğŸ’¬</a>
    <a href="./pages/academy.html" title="Academy">ğŸ“</a>
    <a href="./pages/pengaturan.html" title="Pengaturan" class="private">âš™ï¸</a>
  </nav>

  <script>
    setInterval(()=>{ const el=document.getElementById('clock');
      if(el) el.textContent=new Date().toLocaleTimeString('id-ID',{hour12:false});
    },1000);
  </script>

  <script type="module">
    import { auth, db } from "./js/firebase.js";
    import { UNIT_ID, UNIT_NAME } from "./js/config.js";
    import { collection, query, where, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    auth.onAuthStateChanged(u=>{ document.body.classList.toggle('logged-in', !!u); });
    const nameEl = document.getElementById('portalName');
    if(nameEl) nameEl.textContent = UNIT_NAME;

    function el(html){ const d=document.createElement('div'); d.innerHTML=html.trim(); return d.firstChild; }

    async function loadBerita(){
      const wrap = document.getElementById('beritaList');
      try{
        const qB = query(collection(db,"berita"),
          where("unit","==", UNIT_ID), where("published","==", true),
          orderBy("tanggal","desc"), limit(3));
        const s = await getDocs(qB);
        if(s.empty){ wrap.innerHTML='<div class="info-chip">Belum ada berita.</div>'; return; }
        const nodes=[];
        s.forEach(d=>{
          const x=d.data();
          nodes.push(el(`<a class="item-card" href="./pages/berita.html?id=${d.id}">
            <img class="item-img" src="${x.cover||'./assets/icons/kt.svg'}" alt="">
            <div class="item-title">${x.judul||'Tanpa Judul'}</div>
            <div class="item-meta">${new Date(x.tanggal||Date.now()).toLocaleDateString('id-ID')} â€¢ ${x.kategori||'Umum'}</div>
          </a>`));
        });
        wrap.replaceChildren(...nodes);
      }catch(e){ console.error(e); wrap.innerHTML='<div class="info-chip">Gagal memuat berita.</div>'; }
    }

    async function loadUMKM(){
      const wrap = document.getElementById('umkmList');
      try{
        const qU = query(collection(db,"umkm"),
          where("unit","==", UNIT_ID), where("publik","==", true),
          orderBy("createdAt","desc"), limit(3));
        const s = await getDocs(qU);
        if(s.empty){ wrap.innerHTML='<div class="info-chip">Belum ada UMKM.</div>'; return; }
        const nodes=[];
        s.forEach(d=>{
          const x=d.data();
          nodes.push(el(`<div class="item-card">
            <img class="item-img" src="${x.foto||'./assets/icons/kt.svg'}" alt="">
            <div class="item-title">${x.nama||'UMKM Tanpa Nama'}</div>
            <div class="item-meta">${x.kategori||'-'} ${x.harga?('â€¢ Rp '+Number(x.harga).toLocaleString('id-ID')):''}</div>
            ${x.wa?`<a class="info-chip" style="margin-top:8px;display:inline-block" target="_blank" href="https://wa.me/${x.wa}">WhatsApp</a>`:''}
          </div>`));
        });
        wrap.replaceChildren(...nodes);
      }catch(e){ console.error(e); wrap.innerHTML='<div class="info-chip">Gagal memuat UMKM.</div>'; }
    }

    async function loadAgenda(){
      try{
        const qK = query(collection(db,"kegiatan"),
          where("unit","==", UNIT_ID), where("publik","==", true),
          orderBy("tanggal","asc"), limit(1));
        const s = await getDocs(qK);
        const box = document.getElementById('agendaBox');
        if(s.empty){ box.textContent="Belum ada agenda publik."; return; }
        const d = s.docs[0].data();
        box.textContent = `${new Date(d.tanggal).toLocaleDateString('id-ID')} â€¢ ${d.judul||'Kegiatan'}`;
      }catch(e){}
    }

    await Promise.all([loadBerita(), loadUMKM(), loadAgenda()]);
  </script>

  <script type="module" src="./js/firebase.js"></script>
  <script type="module" src="./js/motion.js"></script>
  <script type="module" src="./js/ui.js"></script>
  <script type="module" src="./js/app.js"></script>
</body>
</html>
