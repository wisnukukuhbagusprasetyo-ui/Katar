<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Portal Karang Taruna Cilosari Barat RT01/RW08</title>
<link rel="stylesheet" href="./css/style.css">
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#0e4c92">
<style>
  /* ringkas styling utama agar cepat */
  :root{--biru:#0e4c92;--emas:#f6c445;--bg:#f5f7fa;--card:#fff;--text:#1e293b}
  body{margin:0;font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--text)}
  header{position:sticky;top:0;z-index:50;background:linear-gradient(90deg,var(--biru),#1a6ac2);color:#fff;display:flex;align-items:center;justify-content:space-between;padding:.8rem 1rem}
  .brand{font-weight:800;letter-spacing:.3px}
  .nav{display:flex;gap:.8rem;align-items:center}
  .nav a,.nav button{color:#fff;text-decoration:none;background:none;border:none;cursor:pointer;font-weight:700}
  .nav a:hover{color:var(--emas)}
  .hamb{display:none;flex-direction:column;gap:4px;cursor:pointer}
  .hamb span{width:24px;height:3px;background:#fff;border-radius:2px}
  @media(max-width:760px){.nav.links{display:none}.hamb{display:flex}}
  .mobile{display:none;flex-direction:column;background:var(--biru);color:#fff}
  .mobile a{padding:12px;border-top:1px solid rgba(255,255,255,.15);text-decoration:none;color:#fff}
  .show{display:flex!important}
  .container{max-width:1100px;margin:auto;padding:1rem}
  .hero{background:linear-gradient(180deg,var(--biru),#1a6ac2);color:#fff;text-align:center;padding:2.8rem 1rem;border-bottom:4px solid var(--emas)}
  .hero h1{margin:0 0 .4rem}
  .section-title{font-size:1.2rem;border-left:6px solid var(--emas);padding-left:.6rem;color:var(--biru);margin:1rem 0}
  .grid{display:grid;gap:1rem}
  @media(min-width:640px){.grid-2{grid-template-columns:repeat(2,1fr)}}
  @media(min-width:900px){.grid-3{grid-template-columns:repeat(3,1fr)}}
  .card{background:var(--card);border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08);padding:1rem;overflow:hidden}
  .thumb{width:100%;height:180px;object-fit:cover;border-radius:8px;margin-bottom:.4rem}
  .btn{display:inline-block;padding:.5rem .8rem;border:none;border-radius:8px;font-weight:700;background:var(--biru);color:#fff;text-decoration:none}
  .btn:hover{background:var(--emas);color:var(--biru)}
  .badge{display:inline-block;background:#eef2ff;color:#3730a3;padding:.2rem .55rem;border-radius:999px;font-size:.8rem;font-weight:800}
  .note{color:#64748b;font-size:.9rem}
  /* modal */
  #authModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);justify-content:center;align-items:center;z-index:100}
  .auth-box{background:#fff;color:#111;padding:1.2rem;border-radius:12px;max-width:360px;width:92%}
  .auth-box input{width:100%;margin-bottom:.6rem;padding:.55rem;border:1px solid #cbd5e1;border-radius:8px}
  footer{background:var(--biru);color:#fff;text-align:center;padding:1rem;margin-top:2rem}
</style>
</head>
<body>
<header>
  <div class="brand">KARTEJI ‚Ä¢ Portal Karang Taruna</div>
  <div class="nav">
    <div class="nav links">
      <a href="#pengumuman">Pengumuman</a>
      <a href="#berita">Berita</a>
      <a href="#umkm">UMKM</a>
      <a href="#kas">Ringkasan Kas</a>
    </div>
    <div id="navAuth"></div>
    <div class="hamb" id="hamb"><span></span><span></span><span></span></div>
  </div>
</header>

<nav class="mobile" id="mnav">
  <a href="#pengumuman">Pengumuman</a>
  <a href="#berita">Berita</a>
  <a href="#umkm">UMKM</a>
  <a href="#kas">Ringkasan Kas</a>
  <a href="#" id="openLogin">Masuk / Daftar</a>
</nav>

<section class="hero">
  <h1>Selamat Datang</h1>
  <p>RT01/RW08 ‚Ä¢ Cilosari Barat, Kelurahan Kemijen, Semarang Timur</p>
</section>

<main class="container">
  <!-- PENGUMUMAN -->
  <section id="pengumuman">
    <h2 class="section-title">üì¢ Pengumuman</h2>
    <div id="pengList" class="grid grid-2"></div>
  </section>

  <!-- BERITA -->
  <section id="berita">
    <h2 class="section-title">üì∞ Berita</h2>
    <div id="beritaList" class="grid grid-3"></div>
  </section>

  <!-- UMKM -->
  <section id="umkm">
    <h2 class="section-title">üè™ Produk</h2>
    <div id="umkmList" class="grid grid-3"></div>
  </section>

  <!-- KAS -->
  <section id="kas">
    <h2 class="section-title">üí∞ Ringkasan Kas</h2>
    <div class="card">
      <div class="badge">Total</div>
      <div id="kasTotal" style="font-size:1.6rem;margin-top:6px">Rp 0</div>
      <p class="note">Detail transaksi kas hanya terlihat oleh anggota saat login.</p>
    </div>
  </section>
</main>

<footer>¬© 2025 Karang Taruna Cilosari Barat RT01/RW08</footer>

<!-- MODAL AUTH -->
<div id="authModal">
  <div class="auth-box">
    <h3 style="margin-top:0">Masuk / Daftar</h3>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="pass" placeholder="Kata sandi">
    <button class="btn" id="btnLogin" style="width:100%;margin-top:.4rem">Masuk</button>
    <button class="btn" id="btnReg" style="width:100%;margin-top:.4rem;background:#f6c445;color:#0e4c92">Daftar</button>
    <button class="btn" id="btnReset" style="width:100%;margin-top:.6rem;background:#0f172a">Lupa Password?</button>
  </div>
</div>

<!-- SCRIPTS -->
<script src="./env.js"></script>
<script src="./js/imgbb.js"></script>
<script src="./js/firebase.js" type="module"></script>
<script src="./js/auth.js" type="module"></script>

<script>
/* ======= NAV ======= */
const hamb=document.getElementById('hamb'), mnav=document.getElementById('mnav');
hamb.onclick=()=>mnav.classList.toggle('show');

/* ======= AUTH MODAL & NAV ======= */
const navAuth=document.getElementById('navAuth');
const modal=document.getElementById('authModal');
const openLogin=document.getElementById('openLogin');
if(openLogin) openLogin.onclick=(e)=>{ e.preventDefault(); modal.style.display='flex'; };
window.addEventListener('click',(e)=>{ if(e.target===modal) modal.style.display='none'; });

function renderAuth(user, role){
  if(user){
    navAuth.innerHTML = `
      <a href="./profil/profil.html">Profil</a>
      ${['admin','super_admin','admin_berita','admin_umkm','admin_keuangan','admin_pengumuman'].includes(role)?'<a href="./profil/profil.html#panel-dashboard">Dashboard</a>':''}
      <button id="btnLogout">Keluar</button>
    `;
    document.getElementById('btnLogout').onclick = ()=> window.AuthAPI.logout();
  }else{
    navAuth.innerHTML = `<a href="#" id="openLoginTop">Masuk / Daftar</a>`;
    const o = document.getElementById('openLoginTop');
    if(o) o.onclick = (e)=>{ e.preventDefault(); modal.style.display='flex'; };
  }
}

/* ======= AUTH ACTIONS ======= */
const emailEl=document.getElementById('email');
const passEl=document.getElementById('pass');
document.getElementById('btnLogin').onclick = async()=>{
  try{ await window.AuthAPI.login(emailEl.value, passEl.value); modal.style.display='none'; }catch(e){ alert(e.message); }
};
document.getElementById('btnReg').onclick = async()=>{
  try{ await window.AuthAPI.register(emailEl.value, passEl.value); modal.style.display='none'; }catch(e){ alert(e.message); }
};
document.getElementById('btnReset').onclick = async()=>{
  try{ await window.AuthAPI.reset(emailEl.value); alert('Link reset dikirim ke email.'); }catch(e){ alert(e.message); }
};

/* ======= STATE & FIRESTORE LOAD ======= */
const { db, auth } = window.__FB;
const pengList=document.getElementById('pengList');
const beritaList=document.getElementById('beritaList');
const umkmList=document.getElementById('umkmList');
const kasTotalEl=document.getElementById('kasTotal');

window.AuthAPI.onAuth(async (user)=>{
  let role='anggota';
  if(user){
    // fetch role
    const { getDoc, doc } = await import("https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js");
    const s = await getDoc(doc(db,'users',user.uid));
    if(s.exists()) role = s.data().role || 'anggota';
  }
  renderAuth(user, role);
});

/* Load Pengumuman, Berita, UMKM, Kas Ringkas */
(async function loadPublic(){
  const { collection, getDocs, query, orderBy } =
    await import("https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js");

  // pengumuman
  try{
    const ps=await getDocs(query(collection(db,'pengumuman'),orderBy('createdAt','desc')));
    if(ps.empty){ pengList.innerHTML='<p class="note">Belum ada pengumuman</p>'; }
    ps.forEach(d=>{
      const p=d.data();
      const el=document.createElement('div'); el.className='card';
      el.innerHTML = `
        <h3>${p.judul||'(Tanpa judul)'}</h3>
        <p style="white-space:pre-line">${(p.isi||'').length>220? (p.isi.slice(0,220)+'...'): (p.isi||'')}</p>
        <a class="btn" href="./berita.html?mode=pengumuman&id=${d.id}">Lihat Selengkapnya</a>`;
      pengList.appendChild(el);
    });
  }catch(e){ pengList.innerHTML='<p class="note">Gagal memuat pengumuman.</p>'; }

  // berita
  try{
    const bs=await getDocs(query(collection(db,'berita'),orderBy('createdAt','desc')));
    if(bs.empty){ beritaList.innerHTML='<p class="note">Belum ada berita</p>'; }
    bs.forEach(d=>{
      const b=d.data();
      const img = Array.isArray(b.foto) ? b.foto[0] : (b.foto || null);
      const el=document.createElement('div'); el.className='card';
      el.innerHTML = `
        ${img?`<img class="thumb" src="${img}" alt="">`:''}
        <h3>${b.judul||'(Tanpa judul)'}</h3>
        <p>${(b.isi||'').length>180? (b.isi.slice(0,180)+'...'): (b.isi||'')}</p>
        <a class="btn" href="./berita.html?id=${d.id}">Selengkapnya</a>`;
      beritaList.appendChild(el);
    });
  }catch(e){ beritaList.innerHTML='<p class="note">Gagal memuat berita.</p>'; }

  // umkm
  try{
    const us=await getDocs(query(collection(db,'umkm'),orderBy('createdAt','desc')));
    if(us.empty){ umkmList.innerHTML='<p class="note">Belum ada produk</p>'; }
    us.forEach(d=>{
      const u=d.data();
      const img = Array.isArray(u.foto) ? u.foto[0] : (u.foto || null);
      const el=document.createElement('div'); el.className='card';
      el.innerHTML = `
        ${img?`<img class="thumb" src="${img}" alt="">`:''}
        <h3>${u.produk||'(Produk)'}</h3>
        <p>üë§ ${u.penjual||'-'} ‚Ä¢ üí∞ Rp${(u.harga||0).toLocaleString()}</p>
        ${u.wa?`<a class="btn" href="https://wa.me/${u.wa}" target="_blank">Hubungi</a>`:''}`;
      umkmList.appendChild(el);
    });
  }catch(e){ umkmList.innerHTML='<p class="note">Gagal memuat UMKM.</p>'; }

  // kas ringkas
  try{
    const ks=await getDocs(collection(db,'kas'));
    let total=0; ks.forEach(k=>{
      const v=k.data();
      total += (v.tipe==='masuk'?1:-1) * (v.jumlah||0);
    });
    kasTotalEl.textContent = 'Rp '+ total.toLocaleString();
  }catch(e){
    kasTotalEl.textContent = 'Rp 0';
  }
})();
</script>
</body>
</html>