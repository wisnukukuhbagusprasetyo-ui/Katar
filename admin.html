<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Dashboard | Karang Taruna Cilosari Barat</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--primary:#0e4c92;--accent:#f6c445;--bg:#f3f4f6;--text:#1f2937;--card:#fff;--shadow:rgba(0,0,0,.08)}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:'Poppins',sans-serif}

/* Header */
.header{display:flex;justify-content:space-between;align-items:center;
  padding:.8rem 1rem;background:linear-gradient(90deg,var(--primary),#1a6ac2);color:#fff}
.header .title{font-weight:700;font-size:1rem}
.header .logout{background:#fff;color:var(--primary);border:none;border-radius:8px;padding:.45rem .8rem;font-weight:700;cursor:pointer}

/* Layout */
.wrapper{display:grid;grid-template-columns:240px 1fr;gap:1rem;padding:1rem}
@media(max-width:920px){.wrapper{grid-template-columns:1fr}}
/* Sidebar */
.sidebar{background:var(--card);border-radius:12px;box-shadow:0 2px 12px var(--shadow);padding:.6rem}
.side-item{display:block;width:100%;text-align:left;background:transparent;border:none;padding:.55rem .7rem;border-radius:8px;font-weight:600;color:var(--primary);cursor:pointer}
.side-item.active{background:var(--accent);color:var(--primary)}
/* Content */
.content{min-height:60vh}
.panel{display:none}
.panel.active{display:block}
.card{background:var(--card);border-radius:12px;box-shadow:0 2px 12px var(--shadow);padding:1rem;margin-bottom:1rem}
.card img{max-width:240px;width:100%;border-radius:8px}
input,textarea,select{width:100%;padding:.65rem;border:1px solid #cbd5e1;border-radius:8px;margin:.5rem 0}
.btn{border:none;border-radius:8px;padding:.6rem 1rem;font-weight:700;cursor:pointer}
.btn-primary{background:var(--primary);color:#fff}
.btn-primary:hover{opacity:.9}
.grid{display:grid;gap:1rem}
@media(min-width:680px){.grid-2{grid-template-columns:repeat(2,1fr)} .grid-3{grid-template-columns:repeat(3,1fr)}}
.badge{display:inline-block;background:#eef2ff;color:#3730a3;padding:.15rem .5rem;border-radius:999px;font-size:.8rem;font-weight:700}
.mini{display:flex;gap:.6rem;align-items:center}
.mini img{width:44px;height:44px;border-radius:50%;object-fit:cover;background:#e5e7eb}
.row{display:flex;gap:.5rem;flex-wrap:wrap}
</style>
</head>
<body>
<header class="header">
  <div class="title">Dashboard Karang Taruna</div>
  <button id="logout" class="logout">Keluar</button>
</header>

<main class="wrapper">
  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar"></aside>

  <!-- CONTENT -->
  <section class="content">
    <!-- PROFIL SAYA -->
    <div id="panel-profil" class="panel active">
      <div class="card">
        <h2>ğŸ‘¤ Profil Saya</h2>
        <div class="mini"><img id="fotoSaya" alt=""><div><div id="namaSaya">-</div><small id="emailSaya">-</small><div id="roleSaya" class="badge">-</div></div></div>
      </div>
      <div class="card">
        <h3>Ubah Profil</h3>
        <div class="grid grid-2">
          <div>
            <label>Nama Lengkap</label>
            <input id="namaProfil" placeholder="Nama lengkap">
          </div>
          <div>
            <label>Foto Profil</label>
            <input type="file" id="fotoProfil" accept="image/*">
          </div>
        </div>
        <button class="btn btn-primary" id="saveProfil">ğŸ’¾ Simpan Profil</button>
      </div>
    </div>

    <!-- ANGGOTA (MANAGEMENT USER) - hanya super_admin; admin = read-only -->
    <div id="panel-anggota" class="panel">
      <div class="card">
        <h2>ğŸ‘¥ Anggota & Manajemen Role</h2>
        <div id="anggotaList" class="grid"></div>
      </div>
    </div>

    <!-- BERITA -->
    <div id="panel-berita" class="panel">
      <div class="card">
        <h2>ğŸ“° Berita</h2>
        <input id="bJudul" placeholder="Judul berita">
        <textarea id="bIsi" rows="5" placeholder="Isi berita..."></textarea>
        <input type="file" id="bFoto" accept="image/*">
        <div class="row">
          <button class="btn btn-primary" id="bSimpan">ğŸ–Šï¸ Simpan</button>
          <button class="btn" id="bBatal" style="display:none">âŒ Batal</button>
        </div>
      </div>
      <div id="beritaList" class="grid grid-2"></div>
    </div>

    <!-- UMKM -->
    <div id="panel-umkm" class="panel">
      <div class="card">
        <h2>ğŸª UMKM</h2>
        <input id="uNama" placeholder="Nama UMKM">
        <input id="uHarga" type="number" placeholder="Harga (contoh: 15000)">
        <input id="uWa" placeholder="Nomor WhatsApp (628xxx)">
        <textarea id="uDes" rows="3" placeholder="Deskripsi singkat"></textarea>
        <input type="file" id="uFoto" accept="image/*">
        <div class="row">
          <button class="btn btn-primary" id="uSimpan">ğŸ–Šï¸ Simpan</button>
          <button class="btn" id="uBatal" style="display:none">âŒ Batal</button>
        </div>
      </div>
      <div id="umkmList" class="grid grid-2"></div>
    </div>

    <!-- KAS -->
    <div id="panel-kas" class="panel">
      <div class="card">
        <h2>ğŸ’° Kas</h2>
        <div class="grid grid-3">
          <div><label>Jumlah (Rp)</label><input id="kJumlah" type="number" placeholder="cth: 50000"></div>
          <div><label>Tipe</label><select id="kTipe"><option value="masuk">Pemasukan</option><option value="keluar">Pengeluaran</option></select></div>
          <div><label>Keterangan</label><input id="kKet" placeholder="cth: Iuran mingguan"></div>
        </div>
        <button class="btn btn-primary" id="kSimpan">Simpan Kas</button>
      </div>
      <div id="kasList" class="grid grid-2"></div>
    </div>
  </section>
</main>

<script type="module">
import { auth, db } from './js/firebase.js';
import { onAuth, logoutUser } from './js/auth.js';
import { uploadToImgBB } from './js/imgbb.js';
import {
  collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, serverTimestamp,
  updateDoc, getDoc, setDoc
} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

/* ====== Auth gate ====== */
const sidebar=document.getElementById('sidebar');
const panels=document.querySelectorAll('.panel');
const logoutBtn=document.getElementById('logout');

let CURRENT_ROLE='anggota';
let UID=null;

onAuth(async(user)=>{
  if(!user){ alert("Silakan login dulu."); location.href="./index.html"; return; }
  UID=user.uid;

  // Ambil profil & role
  const uref=doc(db,'users',UID);
  const usnap=await getDoc(uref);
  const data=usnap.exists()?usnap.data():{};
  CURRENT_ROLE = data.role || 'anggota';

  // Render profil saya
  document.getElementById('emailSaya').textContent = user.email;
  document.getElementById('roleSaya').textContent  = CURRENT_ROLE;
  document.getElementById('namaSaya').textContent  = data.nama || '(Belum diisi)';
  document.getElementById('fotoSaya').src          = data.foto || 'https://i.ibb.co/4Jf2V2R/placeholder-user.png';

  // Sidebar: role-based
  const items = [
    { id:'profil',  label:'Profil Saya', show:true },
    { id:'anggota', label:'Anggota/Role', show: CURRENT_ROLE==='super_admin' || CURRENT_ROLE==='admin' },
    { id:'berita',  label:'Berita', show: CURRENT_ROLE!=='anggota' || true /* anggota boleh lihat & tambah jika diizinkan */ },
    { id:'umkm',    label:'UMKM', show: CURRENT_ROLE!=='anggota' || true },
    { id:'kas',     label:'Kas', show: CURRENT_ROLE==='super_admin' || CURRENT_ROLE==='admin' }
  ];
  sidebar.innerHTML='';
  items.filter(x=>x.show).forEach((x,i)=>{
    const b=document.createElement('button');
    b.className='side-item'+(i===0?' active':'');
    b.textContent=x.label.toUpperCase();
    b.onclick=()=>{
      document.querySelectorAll('.side-item').forEach(s=>s.classList.remove('active'));
      b.classList.add('active');
      panels.forEach(p=>p.classList.remove('active'));
      document.getElementById('panel-'+x.id).classList.add('active');
      if(x.id==='anggota') loadAnggota();
      if(x.id==='berita')  loadBerita();
      if(x.id==='umkm')    loadUmkm();
      if(x.id==='kas')     loadKas();
    };
    sidebar.appendChild(b);
  });

  // Muat panel default
  loadBerita(); loadUmkm(); if(CURRENT_ROLE!=='anggota') loadKas();
});

logoutBtn.onclick=async()=>{await logoutUser();location.href='./index.html';};

/* ====== PROFIL SAYA ====== */
const saveProfil=document.getElementById('saveProfil');
saveProfil.onclick=async()=>{
  const nama=document.getElementById('namaProfil').value.trim();
  const file=document.getElementById('fotoProfil').files[0];
  let foto="";
  if(file) foto = await uploadToImgBB(file);
  await setDoc(doc(db,'users',UID),{ ...(nama && {nama}), ...(foto && {foto}) },{merge:true});
  alert("Profil disimpan.");
  // refresh display
  const s=await getDoc(doc(db,'users',UID));
  const d=s.data()||{};
  document.getElementById('namaSaya').textContent=d.nama||'(Belum diisi)';
  if(d.foto) document.getElementById('fotoSaya').src=d.foto;
};

/* ====== ANGGOTA / ROLE MANAGEMENT ====== */
const anggotaList=document.getElementById('anggotaList');
async function loadAnggota(){
  anggotaList.innerHTML='Memuat...';
  const snap=await getDocs(query(collection(db,'users')));
  anggotaList.innerHTML='';
  snap.forEach(docu=>{
    const u=docu.data(); const id=docu.id;
    const card=document.createElement('div'); card.className='card';
    card.innerHTML = `
      <div class="mini">
        <img src="${u.foto||'https://i.ibb.co/4Jf2V2R/placeholder-user.png'}" alt="">
        <div>
          <div><b>${u.nama||'(Tanpa nama)'}</b> <span class="badge">${u.role||'anggota'}</span></div>
          <small>${u.email||''}</small>
        </div>
      </div>
      <div class="row" style="margin-top:.6rem">
        <select id="role-${id}" ${CURRENT_ROLE==='admin'?'disabled':''}>
          <option value="anggota" ${u.role==='anggota'?'selected':''}>anggota</option>
          <option value="admin" ${u.role==='admin'?'selected':''}>admin</option>
          <option value="super_admin" ${u.role==='super_admin'?'selected':''}>super_admin</option>
        </select>
        <button class="btn btn-primary" id="save-${id}" ${CURRENT_ROLE==='admin'?'disabled':''}>Simpan Role</button>
        <button class="btn" id="del-${id}" ${CURRENT_ROLE==='admin'?'disabled':''}>Soft Delete</button>
      </div>
    `;
    anggotaList.appendChild(card);

    document.getElementById(`save-${id}`).onclick=async()=>{
      const newRole=(document.getElementById(`role-${id}`)).value;
      await setDoc(doc(db,'users',id),{role:newRole},{merge:true});
      alert("Role diperbarui.");
      loadAnggota();
    };
    document.getElementById(`del-${id}`).onclick=async()=>{
      if(!confirm('Tandai user ini sebagai non-aktif?')) return;
      await setDoc(doc(db,'users',id),{status:'inactive'},{merge:true});
      alert('User ditandai non-aktif. (Catatan: penghapusan akun Auth perlu Admin SDK)');
      loadAnggota();
    };
  });
}

/* ====== BERITA (CRUD) ====== */
let editBeritaId=null;
const bJudul=document.getElementById('bJudul');
const bIsi=document.getElementById('bIsi');
const bFoto=document.getElementById('bFoto');
const bSimpan=document.getElementById('bSimpan');
const bBatal=document.getElementById('bBatal');
const beritaList=document.getElementById('beritaList');

bSimpan.onclick=async()=>{
  const judul=bJudul.value.trim(); const isi=bIsi.value.trim();
  if(!judul || !isi){ alert('Judul & isi wajib.'); return; }
  let foto=""; if(bFoto.files[0]) foto=await uploadToImgBB(bFoto.files[0]);

  if(editBeritaId){
    await updateDoc(doc(db,'berita',editBeritaId),{judul,isi,...(foto&&{foto})});
    editBeritaId=null; bBatal.style.display='none';
  }else{
    await addDoc(collection(db,'berita'),{judul,isi,foto,penulis:auth.currentUser.email,createdAt:serverTimestamp()});
  }
  bJudul.value=''; bIsi.value=''; bFoto.value='';
  loadBerita();
};
bBatal.onclick=()=>{editBeritaId=null;bJudul.value='';bIsi.value='';bFoto.value='';bBatal.style.display='none';};

async function loadBerita(){
  const snap=await getDocs(query(collection(db,'berita'),orderBy('createdAt','desc')));
  beritaList.innerHTML='';
  snap.forEach(d=>{
    const b=d.data();
    const card=document.createElement('div'); card.className='card';
    card.innerHTML = `
      ${b.foto?`<img src="${b.foto}" alt="">`:''}
      <h3>${b.judul}</h3>
      <p>${b.isi}</p>
      <small>oleh ${b.penulis||'anonim'}</small>
      <div class="row" style="margin-top:.5rem">
        <button class="btn btn-primary" id="be-${d.id}">Edit</button>
        <button class="btn" id="bd-${d.id}">Hapus</button>
      </div>`;
    beritaList.appendChild(card);
    document.getElementById(`be-${d.id}`).onclick=async()=>{
      const ds=await getDoc(doc(db,'berita',d.id)); const v=ds.data();
      bJudul.value=v.judul; bIsi.value=v.isi; editBeritaId=d.id; bBatal.style.display='inline-block';
      window.scrollTo({top:0,behavior:'smooth'});
    };
    document.getElementById(`bd-${d.id}`).onclick=async()=>{
      if(confirm('Hapus berita ini?')){ await deleteDoc(doc(db,'berita',d.id)); loadBerita(); }
    };
  });
}

/* ====== UMKM (CRUD) ====== */
let editUmkmId=null;
const uNama=document.getElementById('uNama');
const uHarga=document.getElementById('uHarga');
const uWa=document.getElementById('uWa');
const uDes=document.getElementById('uDes');
const uFoto=document.getElementById('uFoto');
const uSimpan=document.getElementById('uSimpan');
const uBatal=document.getElementById('uBatal');
const umkmList=document.getElementById('umkmList');

uSimpan.onclick=async()=>{
  const nama=uNama.value.trim();
  const harga=Number(uHarga.value||0);
  const wa=uWa.value.trim();
  const des=uDes.value.trim();
  let foto=""; if(uFoto.files[0]) foto=await uploadToImgBB(uFoto.files[0]);

  if(!nama || !wa){ alert('Nama & WhatsApp wajib.'); return; }

  if(editUmkmId){
    await updateDoc(doc(db,'umkm',editUmkmId),{nama,harga,wa,deskripsi:des,...(foto&&{foto})});
    editUmkmId=null; uBatal.style.display='none';
  }else{
    await addDoc(collection(db,'umkm'),{nama,harga,wa,deskripsi:des,foto,createdAt:serverTimestamp()});
  }
  uNama.value='';uHarga.value='';uWa.value='';uDes.value='';uFoto.value='';
  loadUmkm();
};
uBatal.onclick=()=>{editUmkmId=null;uNama.value='';uHarga.value='';uWa.value='';uDes.value='';uFoto.value='';uBatal.style.display='none';};

async function loadUmkm(){
  const snap=await getDocs(query(collection(db,'umkm'),orderBy('createdAt','desc')));
  umkmList.innerHTML='';
  snap.forEach(d=>{
    const u=d.data();
    const card=document.createElement('div'); card.className='card';
    card.innerHTML = `
      ${u.foto?`<img src="${u.foto}" alt="">`:''}
      <h3>${u.nama}</h3>
      <p>ğŸ’° Rp${(u.harga||0).toLocaleString()}</p>
      <p>${u.deskripsi||''}</p>
      <p>ğŸ“± <a target="_blank" href="https://wa.me/${u.wa}">${u.wa}</a></p>
      <div class="row" style="margin-top:.5rem">
        <button class="btn btn-primary" id="ue-${d.id}">Edit</button>
        <button class="btn" id="ud-${d.id}">Hapus</button>
      </div>`;
    umkmList.appendChild(card);
    document.getElementById(`ue-${d.id}`).onclick=async()=>{
      const ds=await getDoc(doc(db,'umkm',d.id)); const v=ds.data();
      uNama.value=v.nama; uHarga.value=v.harga; uWa.value=v.wa; uDes.value=v.deskripsi||''; editUmkmId=d.id; uBatal.style.display='inline-block';
      window.scrollTo({top:0,behavior:'smooth'});
    };
    document.getElementById(`ud-${d.id}`).onclick=async()=>{
      if(confirm('Hapus UMKM ini?')){ await deleteDoc(doc(db,'umkm',d.id)); loadUmkm(); }
    };
  });
}

/* ====== KAS ====== */
const kJumlah=document.getElementById('kJumlah');
const kTipe=document.getElementById('kTipe');
const kKet=document.getElementById('kKet');
const kSimpan=document.getElementById('kSimpan');
const kasList=document.getElementById('kasList');

kSimpan.onclick=async()=>{
  await addDoc(collection(db,'kas'),{
    jumlah:Number(kJumlah.value||0), tipe:kTipe.value, keterangan:kKet.value, createdAt:serverTimestamp()
  });
  kJumlah.value=''; kKet.value='';
  loadKas();
};
async function loadKas(){
  const snap=await getDocs(query(collection(db,'kas'),orderBy('createdAt','desc')));
  kasList.innerHTML=''; let total=0;
  snap.forEach(d=>{
    const k=d.data(); total += (k.tipe==='masuk'?1:-1)*(k.jumlah||0);
    const card=document.createElement('div'); card.className='card';
    card.innerHTML=`<b>${k.tipe==='masuk'?'ğŸŸ¢ Pemasukan':'ğŸ”´ Pengeluaran'} Rp${(k.jumlah||0).toLocaleString()}</b><br>${k.keterangan||''}`;
    kasList.appendChild(card);
  });
  const sum=document.createElement('div'); sum.className='card'; sum.innerHTML=`<h3>Total Kas: Rp${total.toLocaleString()}</h3>`;
  kasList.prepend(sum);
}
</script>
</body>
</html>