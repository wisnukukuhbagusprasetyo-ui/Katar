<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Dashboard | Karang Taruna Cilosari Barat</title>
<style>
body{font-family:'Poppins',sans-serif;margin:0;background:#f9fafb;}
header{background:#0e4c92;color:#fff;padding:1rem;display:flex;justify-content:space-between;align-items:center;}
#logout{background:#fff;color:#0e4c92;border:none;padding:.5rem 1rem;border-radius:6px;font-weight:600;cursor:pointer;}
.panel{display:none;padding:1rem;}
.panel.active{display:block;}
nav{display:flex;gap:1rem;background:#fff;padding:.6rem 1rem;box-shadow:0 2px 5px rgba(0,0,0,.1);}
nav button{background:none;border:none;font-weight:600;cursor:pointer;color:#0e4c92;}
nav button.active{color:#f6c445;}
h2{color:#0e4c92;}
.card{background:#fff;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.08);padding:1rem;margin-bottom:1rem;}
</style>
</head>
<body>
<header>
  <h1>Dashboard Karang Taruna</h1>
  <button id="logout">Keluar</button>
</header>

<nav id="menu"></nav>

<section id="berita" class="panel">
  <h2>Panel Berita</h2>
  <form id="formBerita">
    <input type="text" id="judul" placeholder="Judul berita" required><br>
    <textarea id="isi" placeholder="Isi berita..." required></textarea><br>
    <input type="file" id="gambar"><br>
    <button type="submit">Simpan</button>
  </form>
  <div id="listBerita"></div>
</section>

<section id="umkm" class="panel">
  <h2>Panel UMKM</h2>
  <form id="formUmkm">
    <input type="text" id="nama" placeholder="Nama UMKM" required><br>
    <textarea id="deskripsi" placeholder="Deskripsi singkat"></textarea><br>
    <input type="file" id="fotoUmkm"><br>
    <button type="submit">Simpan</button>
  </form>
  <div id="listUmkm"></div>
</section>

<section id="kas" class="panel">
  <h2>Panel Kas</h2>
  <form id="formKas">
    <input type="number" id="jumlah" placeholder="Jumlah (Rp)" required><br>
    <select id="tipe" required>
      <option value="masuk">Pemasukan</option>
      <option value="keluar">Pengeluaran</option>
    </select><br>
    <input type="text" id="keterangan" placeholder="Keterangan"><br>
    <button type="submit">Simpan Kas</button>
  </form>
  <div id="listKas"></div>
</section>

<section id="profil" class="panel">
  <h2>Profil Akun</h2>
  <p id="info"></p>
</section>

<script type="module">
import { auth, db } from './js/firebase.js';
import { onAuth, logoutUser, getUserRole } from './js/auth.js';
import { uploadToImgBB } from './js/imgbb.js';
import { collection, addDoc, getDocs, deleteDoc, doc, orderBy, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

const logout=document.getElementById('logout');
const menu=document.getElementById('menu');
const panels=document.querySelectorAll('.panel');
const info=document.getElementById('info');

onAuth(async(user)=>{
  if(!user){
    alert("Silakan login terlebih dahulu!");
    location.href="./index.html";
    return;
  }

  const role=await getUserRole(user.uid);
  info.innerHTML=`Email: ${user.email}<br>Role: <b>${role}</b>`;

  // role-based visibility
  const allowed={
    super_admin:["berita","umkm","kas","profil"],
    admin:["berita","umkm","profil"],
    anggota:["profil"]
  }[role] || ["profil"];

  // buat menu dinamis
  menu.innerHTML="";
  allowed.forEach(id=>{
    const b=document.createElement('button');
    b.textContent=id.toUpperCase();
    b.onclick=()=>{
      panels.forEach(p=>p.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      menu.querySelectorAll('button').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
    };
    menu.appendChild(b);
  });

  // buka tab pertama
  document.getElementById(allowed[0]).classList.add('active');
  menu.querySelector('button').classList.add('active');
});

logout.onclick=async()=>{await logoutUser();location.href="./index.html";};

/* ====== Panel Berita ====== */
const formBerita=document.getElementById('formBerita');
const listBerita=document.getElementById('listBerita');

formBerita.onsubmit=async(e)=>{
  e.preventDefault();
  const file=document.getElementById('gambar').files[0];
  let foto="";
  if(file) foto=await uploadToImgBB(file);
  await addDoc(collection(db,'berita'),{
    judul:judul.value,
    isi:isi.value,
    foto,
    createdAt:serverTimestamp()
  });
  formBerita.reset();
  alert("Berita disimpan!");
  loadBerita();
};

async function loadBerita(){
  const snap=await getDocs(query(collection(db,'berita'),orderBy('createdAt','desc')));
  listBerita.innerHTML="";
  snap.forEach(d=>{
    const b=d.data();
    const div=document.createElement('div');
    div.className='card';
    div.innerHTML=`<h3>${b.judul}</h3><p>${b.isi}</p>${b.foto?`<img src="${b.foto}" width="200">`:''}
    <button onclick="hapusBerita('${d.id}')">Hapus</button>`;
    listBerita.appendChild(div);
  });
}
window.hapusBerita=async(id)=>{
  if(confirm("Hapus berita ini?")) await deleteDoc(doc(db,'berita',id));
  loadBerita();
};
loadBerita();

/* ====== Panel UMKM ====== */
const formUmkm=document.getElementById('formUmkm');
const listUmkm=document.getElementById('listUmkm');

formUmkm.onsubmit=async(e)=>{
  e.preventDefault();
  const file=document.getElementById('fotoUmkm').files[0];
  let foto="";
  if(file) foto=await uploadToImgBB(file);
  await addDoc(collection(db,'umkm'),{
    nama:nama.value,
    deskripsi:deskripsi.value,
    foto,
    createdAt:serverTimestamp()
  });
  formUmkm.reset();
  alert("UMKM disimpan!");
  loadUmkm();
};

async function loadUmkm(){
  const snap=await getDocs(query(collection(db,'umkm'),orderBy('createdAt','desc')));
  listUmkm.innerHTML="";
  snap.forEach(d=>{
    const u=d.data();
    const div=document.createElement('div');
    div.className='card';
    div.innerHTML=`<h3>${u.nama}</h3><p>${u.deskripsi}</p>${u.foto?`<img src="${u.foto}" width="200">`:''}
    <button onclick="hapusUmkm('${d.id}')">Hapus</button>`;
    listUmkm.appendChild(div);
  });
}
window.hapusUmkm=async(id)=>{
  if(confirm("Hapus UMKM ini?")) await deleteDoc(doc(db,'umkm',id));
  loadUmkm();
};
loadUmkm();

/* ====== Panel Kas ====== */
const formKas=document.getElementById('formKas');
const listKas=document.getElementById('listKas');

formKas.onsubmit=async(e)=>{
  e.preventDefault();
  await addDoc(collection(db,'kas'),{
    jumlah:Number(jumlah.value),
    tipe:tipe.value,
    keterangan:keterangan.value,
    createdAt:serverTimestamp()
  });
  formKas.reset();
  alert("Data kas disimpan!");
  loadKas();
};

async function loadKas(){
  const snap=await getDocs(query(collection(db,'kas'),orderBy('createdAt','desc')));
  listKas.innerHTML="";
  let total=0;
  snap.forEach(d=>{
    const k=d.data();
    total+=k.tipe==='masuk'?k.jumlah:-k.jumlah;
    const div=document.createElement('div');
    div.className='card';
    div.innerHTML=`<b>${k.tipe==='masuk'?'ðŸŸ¢ Pemasukan':'ðŸ”´ Pengeluaran'} Rp${k.jumlah.toLocaleString()}</b><br>${k.keterangan||''}`;
    listKas.appendChild(div);
  });
  const sum=document.createElement('div');
  sum.innerHTML=`<h3>Total Kas: Rp${total.toLocaleString()}</h3>`;
  listKas.prepend(sum);
}
loadKas();
</script>
</body>
</html>