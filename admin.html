<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Admin | Karang Taruna Cilosari Barat</title>
<link rel="icon" href="./assets/logo.svg">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
/* ======== STYLE UMUM ======== */
body{
  font-family:'Poppins',sans-serif;
  background:#f9fafb;
  color:#1e293b;
  margin:0;
}
header{
  background:#0e4c92;
  color:#fff;
  padding:1rem 1.5rem;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.logout{
  background:#fff;
  color:#0e4c92;
  padding:.4rem .8rem;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-weight:600;
}
nav{
  display:flex;
  justify-content:center;
  gap:1rem;
  background:#fff;
  padding:.8rem 0;
  box-shadow:0 1px 6px rgba(0,0,0,.1);
  position:sticky;
  top:0;
  z-index:99;
}
nav a{
  color:#0e4c92;
  text-decoration:none;
  font-weight:600;
}
nav a.active{color:#f6c445}
section{display:none;padding:1rem 1.5rem}
section.active{display:block}
input,textarea,select{
  width:100%;
  padding:.6rem;
  border:1px solid #ccc;
  border-radius:8px;
  margin-bottom:.6rem;
  font-family:'Poppins',sans-serif;
}
button{
  background:#0e4c92;
  color:#fff;
  border:none;
  padding:.7rem 1.2rem;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
}
button:hover{background:#f6c445;color:#0e4c92}
.card{
  background:#fff;
  padding:1rem;
  border-radius:8px;
  box-shadow:0 2px 8px rgba(0,0,0,.05);
  margin-bottom:1rem;
  position:relative;
}
img{max-width:100%;border-radius:8px;margin-top:.5rem}
.delBtn{
  position:absolute;
  top:10px;
  right:10px;
  background:#e63946;
  color:#fff;
  border:none;
  padding:.3rem .6rem;
  border-radius:4px;
  cursor:pointer;
}
footer{text-align:center;padding:1rem;color:#64748b;margin-top:2rem}
</style>
</head>

<body>
<header>
  <h1>Dashboard Admin ‚Äì Karang Taruna Cilosari Barat</h1>
  <button id="logoutBtn" class="logout">Keluar</button>
</header>

<nav>
  <a href="#" class="active" data-tab="berita">üì∞ Berita</a>
  <a href="#" data-tab="umkm">üè™ UMKM</a>
  <a href="#" data-tab="kas">üí∞ Kas</a>
</nav>

<!-- ======== BERITA ======== -->
<section id="berita" class="active">
  <h2>Tambah Berita</h2>
  <form id="formBerita">
    <input type="text" name="judul" placeholder="Judul berita" required>
    <textarea name="isi" placeholder="Isi berita..." required></textarea>
    <input type="file" id="gambarBerita" accept="image/*">
    <button type="submit">Simpan Berita</button>
  </form>
  <div id="listBerita"></div>
</section>

<!-- ======== UMKM ======== -->
<section id="umkm">
  <h2>Tambah UMKM</h2>
  <form id="formUmkm">
    <input type="text" name="nama" placeholder="Nama UMKM" required>
    <textarea name="deskripsi" placeholder="Deskripsi singkat..."></textarea>
    <input type="file" id="fotoUmkm" accept="image/*">
    <button type="submit">Simpan UMKM</button>
  </form>
  <div id="listUmkm"></div>
</section>

<!-- ======== KAS ======== -->
<section id="kas">
  <h2>Tambah Kas</h2>
  <form id="formKas">
    <input type="number" name="jumlah" placeholder="Jumlah (Rp)" required>
    <select name="tipe" required>
      <option value="masuk">Pemasukan</option>
      <option value="keluar">Pengeluaran</option>
    </select>
    <input type="text" name="keterangan" placeholder="Keterangan">
    <button type="submit">Simpan Kas</button>
  </form>
  <div id="listKas"></div>
</section>

<footer>¬© 2025 Karang Taruna Cilosari Barat RT01/RW08</footer>

<!-- ============= SCRIPT SECTION ============= -->
<script type="module">

/* =====================================================
   Proteksi Login Firebase (WAJIB LOGIN DULU)
===================================================== */
import { auth, db, uploadToImgBB, logout } from './js/firebase.js';
import { onAuthStateChanged } 
  from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
import { 
  collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

// Cek apakah user sudah login
onAuthStateChanged(auth, (user) => {
  if (!user) {
    alert("Silakan login terlebih dahulu!");
    location.href = "./login.html";
  } else {
    console.log("[Login terdeteksi]", user.email);
  }
});

// Tombol Logout
document.getElementById('logoutBtn').onclick = async() => {
  await logout();
  location.href = "./login.html";
};

/* =====================================================
   Navigasi antar Tab
===================================================== */
document.querySelectorAll('nav a').forEach(a => {
  a.onclick = e => {
    e.preventDefault();
    document.querySelectorAll('nav a').forEach(x => x.classList.remove('active'));
    document.querySelectorAll('section').forEach(x => x.classList.remove('active'));
    a.classList.add('active');
    document.getElementById(a.dataset.tab).classList.add('active');
  };
});

/* =====================================================
   FUNGSI CRUD: BERITA
===================================================== */
const fB = document.getElementById('formBerita');
const listB = document.getElementById('listBerita');

fB.onsubmit = async (e) => {
  e.preventDefault();
  const file = document.getElementById('gambarBerita').files[0];
  let foto = "";
  if (file) foto = await uploadToImgBB(file);

  await addDoc(collection(db, 'berita'), {
    judul: fB.judul.value,
    isi: fB.isi.value,
    foto,
    createdAt: serverTimestamp()
  });

  alert("Berita disimpan!");
  fB.reset();
  loadBerita();
};

async function loadBerita() {
  const snap = await getDocs(query(collection(db, 'berita'), orderBy('createdAt', 'desc')));
  listB.innerHTML = "";
  snap.forEach(d => {
    const b = d.data();
    const div = document.createElement('div');
    div.className = "card";
    div.innerHTML = `
      <h3>${b.judul}</h3>
      <p>${b.isi}</p>
      ${b.foto ? `<img src="${b.foto}" alt="berita">` : ''}
      <button class="delBtn">Hapus</button>
    `;
    div.querySelector('.delBtn').onclick = async () => {
      if (confirm("Hapus berita ini?")) await deleteDoc(doc(db, 'berita', d.id));
      loadBerita();
    };
    listB.appendChild(div);
  });
}
loadBerita();

/* =====================================================
   FUNGSI CRUD: UMKM
===================================================== */
const fU = document.getElementById('formUmkm');
const listU = document.getElementById('listUmkm');

fU.onsubmit = async (e) => {
  e.preventDefault();
  const file = document.getElementById('fotoUmkm').files[0];
  let foto = "";
  if (file) foto = await uploadToImgBB(file);

  await addDoc(collection(db, 'umkm'), {
    nama: fU.nama.value,
    deskripsi: fU.deskripsi.value,
    foto,
    createdAt: serverTimestamp()
  });

  alert("UMKM disimpan!");
  fU.reset();
  loadUmkm();
};

async function loadUmkm() {
  const snap = await getDocs(query(collection(db, 'umkm'), orderBy('createdAt', 'desc')));
  listU.innerHTML = "";
  snap.forEach(d => {
    const u = d.data();
    const div = document.createElement('div');
    div.className = "card";
    div.innerHTML = `
      <h3>${u.nama}</h3>
      <p>${u.deskripsi || ''}</p>
      ${u.foto ? `<img src="${u.foto}" alt="${u.nama}">` : ''}
      <button class="delBtn">Hapus</button>
    `;
    div.querySelector('.delBtn').onclick = async () => {
      if (confirm("Hapus UMKM ini?")) await deleteDoc(doc(db, 'umkm', d.id));
      loadUmkm();
    };
    listU.appendChild(div);
  });
}
loadUmkm();

/* =====================================================
   FUNGSI CRUD: KAS
===================================================== */
const fK = document.getElementById('formKas');
const listK = document.getElementById('listKas');

fK.onsubmit = async (e) => {
  e.preventDefault();
  await addDoc(collection(db, 'kas'), {
    jumlah: Number(fK.jumlah.value),
    tipe: fK.tipe.value,
    keterangan: fK.keterangan.value,
    createdAt: serverTimestamp()
  });

  alert("Kas disimpan!");
  fK.reset();
  loadKas();
};

async function loadKas() {
  const snap = await getDocs(query(collection(db, 'kas'), orderBy('createdAt', 'desc')));
  listK.innerHTML = "";
  let total = 0;
  snap.forEach(d => {
    const k = d.data();
    total += k.tipe === "masuk" ? k.jumlah : -k.jumlah;
    const div = document.createElement('div');
    div.className = "card";
    div.innerHTML = `
      <strong>${k.tipe === "masuk" ? "üü¢ Pemasukan" : "üî¥ Pengeluaran"} Rp${k.jumlah.toLocaleString()}</strong>
      <br>${k.keterangan || ''}
    `;
    listK.appendChild(div);
  });

  const totalBox = document.createElement('div');
  totalBox.innerHTML = `<h3>Total Kas: Rp${total.toLocaleString()}</h3>`;
  listK.prepend(totalBox);
}
loadKas();

</script>
</body>
</html>