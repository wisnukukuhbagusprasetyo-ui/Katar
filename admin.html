<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dashboard Karang Taruna Cilosari Barat</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{margin:0;font-family:'Poppins',sans-serif;background:#f5f7fa;color:#1e293b}
header{background:linear-gradient(90deg,#0e4c92,#1a6ac2);color:#fff;padding:1rem;display:flex;justify-content:space-between;align-items:center}
header h1{font-size:1.1rem;margin:0}
header button{background:#f6c445;color:#0e4c92;border:none;border-radius:8px;padding:.5rem .9rem;font-weight:600;cursor:pointer}
.wrapper{display:grid;grid-template-columns:220px 1fr;gap:1rem;padding:1rem}
@media(max-width:850px){.wrapper{grid-template-columns:1fr}}
.sidebar{background:#fff;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.08);padding:.6rem}
.side-item{display:block;width:100%;padding:.55rem .7rem;margin-bottom:.3rem;border:none;background:transparent;font-weight:600;color:#0e4c92;text-align:left;border-radius:6px;cursor:pointer}
.side-item.active{background:#f6c445;color:#0e4c92}
.panel{display:none}
.panel.active{display:block}
.card{background:#fff;padding:1rem;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-bottom:1rem}
input,textarea,select{width:100%;padding:.6rem;margin-bottom:.7rem;border:1px solid #ccc;border-radius:6px;font-family:'Poppins',sans-serif}
.btn{border:none;border-radius:8px;padding:.6rem 1rem;font-weight:600;cursor:pointer}
.btn-primary{background:#0e4c92;color:#fff}
.btn-primary:hover{background:#f6c445;color:#0e4c92}
.grid{display:grid;gap:1rem}
@media(min-width:700px){.grid-2{grid-template-columns:repeat(2,1fr)}}
.mini{display:flex;gap:.6rem;align-items:center}
.mini img{width:44px;height:44px;border-radius:50%;object-fit:cover;background:#e5e7eb}
.badge{display:inline-block;background:#eef2ff;color:#3730a3;padding:.15rem .5rem;border-radius:999px;font-size:.8rem;font-weight:700}
.row{display:flex;gap:.5rem;flex-wrap:wrap}
</style>
</head>
<body>
<header>
  <h1>Dashboard Karang Taruna</h1>
  <button id="logout">Keluar</button>
</header>

<main class="wrapper">
  <aside class="sidebar" id="sidebar"></aside>

  <section class="content">
    <!-- PROFIL -->
    <div id="panel-profil" class="panel active">
      <div class="card">
        <h2>ğŸ‘¤ Profil Saya</h2>
        <p>Email: <span id="emailSaya">-</span></p>
        <p>Role: <span id="roleSaya" class="badge">-</span></p>
        <input id="namaProfil" placeholder="Nama Lengkap">
        <input type="file" id="fotoProfil" accept="image/*">
        <button class="btn btn-primary" id="saveProfil">Simpan Profil</button>
      </div>
    </div>

    <!-- ANGGOTA -->
    <div id="panel-anggota" class="panel">
      <div class="card">
        <h2>ğŸ‘¥ Manajemen Anggota</h2>
        <div id="anggotaList" class="grid"></div>
      </div>
    </div>

    <!-- BERITA -->
    <div id="panel-berita" class="panel">
      <div class="card">
        <h2>ğŸ“° Berita</h2>
        <input id="bJudul" placeholder="Judul Berita">
        <textarea id="bIsi" rows="4" placeholder="Isi Berita"></textarea>
        <input type="file" id="bFoto" accept="image/*">
        <button class="btn btn-primary" id="bSimpan">Simpan</button>
        <button class="btn" id="bBatal" style="display:none">Batal Edit</button>
      </div>
      <div id="beritaList" class="grid grid-2"></div>
    </div>

    <!-- UMKM -->
    <div id="panel-umkm" class="panel">
      <div class="card">
        <h2>ğŸª UMKM</h2>
        <input id="uNama" placeholder="Nama UMKM">
        <input id="uHarga" type="number" placeholder="Harga">
        <input id="uWa" placeholder="Nomor WhatsApp (628xxxx)">
        <textarea id="uDes" rows="3" placeholder="Deskripsi"></textarea>
        <input type="file" id="uFoto" accept="image/*">
        <button class="btn btn-primary" id="uSimpan">Simpan</button>
        <button class="btn" id="uBatal" style="display:none">Batal Edit</button>
      </div>
      <div id="umkmList" class="grid grid-2"></div>
    </div>

    <!-- KAS -->
    <div id="panel-kas" class="panel">
      <div class="card">
        <h2>ğŸ’° Kas</h2>
        <input id="kJumlah" type="number" placeholder="Jumlah">
        <select id="kTipe"><option value="masuk">Pemasukan</option><option value="keluar">Pengeluaran</option></select>
        <input id="kKet" placeholder="Keterangan">
        <button class="btn btn-primary" id="kSimpan">Simpan Kas</button>
      </div>
      <div class="card"><canvas id="kasChart" height="110"></canvas></div>
      <div id="kasList"></div>
    </div>

    <!-- PENGUMUMAN -->
    <div id="panel-pengumuman" class="panel">
      <div class="card">
        <h2>ğŸ“¢ Pengumuman</h2>
        <input id="pJudul" placeholder="Judul Pengumuman">
        <textarea id="pIsi" rows="4" placeholder="Isi Pengumuman"></textarea>
        <input id="pTanggal" type="date">
        <button class="btn btn-primary" id="pSimpan">Simpan</button>
        <button class="btn" id="pBatal" style="display:none">Batal Edit</button>
      </div>
      <div id="pengumumanList" class="grid grid-2"></div>
    </div>
  </section>
</main>

<script type="module">
import { auth, db } from './js/firebase.js';
import { uploadToImgBB } from './js/imgbb.js';
import { logoutUser, onAuth } from './js/auth.js';
import {
  doc, getDoc, collection, addDoc, getDocs, updateDoc, deleteDoc,
  query, orderBy, serverTimestamp, setDoc
} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

let UID=null, CURRENT_ROLE='anggota';
const $=(s)=>document.querySelector(s);

/* ===== LOGOUT ===== */
$('#logout').onclick = async()=>{ await logoutUser(); location.href='./index.html'; };

/* ===== AUTH ===== */
onAuth(async(user)=>{
  if(!user){ alert("Silakan login."); location.href="./index.html"; return; }
  UID=user.uid;
  const uref=doc(db,'users',UID);
  const usnap=await getDoc(uref);
  const udata=usnap.exists()?usnap.data():{};
  CURRENT_ROLE=udata.role||'anggota';
  $('#emailSaya').textContent=user.email;
  $('#roleSaya').textContent=CURRENT_ROLE;
  renderMenu(CURRENT_ROLE);
  if(['super_admin','admin','admin_berita'].includes(CURRENT_ROLE)) loadBerita();
  if(['super_admin','admin','admin_umkm'].includes(CURRENT_ROLE)) loadUmkm();
  if(['super_admin','admin','admin_keuangan'].includes(CURRENT_ROLE)) loadKas();
  if(['super_admin','admin'].includes(CURRENT_ROLE)) loadAnggota();
  if(['super_admin','admin','admin_pengumuman'].includes(CURRENT_ROLE)) loadPengumuman();
});

/* ===== SIDEBAR ===== */
function renderMenu(role){
  const sidebar=$('#sidebar');
  const map={
    super_admin:['profil','anggota','berita','umkm','kas','pengumuman'],
    admin:['profil','anggota','berita','umkm','kas','pengumuman'],
    admin_berita:['profil','berita'],
    admin_umkm:['profil','umkm'],
    admin_keuangan:['profil','kas'],
    admin_pengumuman:['profil','pengumuman'],
    anggota:['profil']
  };
  const list=map[role]||['profil'];
  sidebar.innerHTML='';
  list.forEach((id,i)=>{
    const b=document.createElement('button');
    b.className='side-item'+(i===0?' active':'');
    b.textContent=id.toUpperCase();
    b.onclick=()=>showPanel(id);
    sidebar.appendChild(b);
  });
  showPanel(list[0]);
}
function showPanel(id){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('panel-'+id).classList.add('active');
  document.querySelectorAll('.side-item').forEach(b=>b.classList.remove('active'));
  [...document.querySelectorAll('.side-item')].find(b=>b.textContent===id.toUpperCase())?.classList.add('active');
}

/* ===== PROFIL ===== */
$('#saveProfil').onclick=async()=>{
  const nama=$('#namaProfil').value.trim();
  const file=$('#fotoProfil').files[0];
  let foto="";
  if(file) foto=await uploadToImgBB(file);
  await setDoc(doc(db,'users',UID),{...(nama&&{nama}),...(foto&&{foto})},{merge:true});
  alert("Profil diperbarui!");
};

/* ===== ANGGOTA ===== */
async function loadAnggota(){
  const wrap=$('#anggotaList');
  wrap.innerHTML='Memuat...';
  const snap=await getDocs(query(collection(db,'users'),orderBy('email')));
  wrap.innerHTML='';
  snap.forEach(u=>{
    const d=u.data(); const id=u.id;
    const card=document.createElement('div'); card.className='card';
    card.innerHTML=`
      <div class="mini">
        <img src="${d.foto||'https://i.ibb.co/4Jf2V2R/placeholder-user.png'}">
        <div><div><b>${d.nama||'(Tanpa nama)'}</b> <span class="badge">${d.role||'anggota'}</span></div><small>${d.email||''}</small></div>
      </div>
      <div class="row" style="margin-top:.6rem">
        <select id="role-${id}" ${CURRENT_ROLE!=='super_admin'?'disabled':''}>
          <option value="anggota" ${d.role==='anggota'?'selected':''}>anggota</option>
          <option value="admin" ${d.role==='admin'?'selected':''}>admin</option>
          <option value="admin_berita" ${d.role==='admin_berita'?'selected':''}>admin_berita</option>
          <option value="admin_umkm" ${d.role==='admin_umkm'?'selected':''}>admin_umkm</option>
          <option value="admin_keuangan" ${d.role==='admin_keuangan'?'selected':''}>admin_keuangan</option>
          <option value="admin_pengumuman" ${d.role==='admin_pengumuman'?'selected':''}>admin_pengumuman</option>
          <option value="super_admin" ${d.role==='super_admin'?'selected':''}>super_admin</option>
        </select>
        <button class="btn btn-primary" id="save-${id}" ${CURRENT_ROLE!=='super_admin'?'disabled':''}>Simpan</button>
      </div>`;
    wrap.appendChild(card);
    const saveBtn=document.getElementById(`save-${id}`);
    if(saveBtn) saveBtn.onclick=async()=>{
      const newRole=document.getElementById(`role-${id}`).value;
      await setDoc(doc(db,'users',id),{role:newRole},{merge:true});
      alert("Role diperbarui"); loadAnggota();
    };
  });
}

/* ===== BERITA ===== */
let editBeritaId=null;
$('#bSimpan').onclick=async()=>{
  const judul=$('#bJudul').value.trim(), isi=$('#bIsi').value.trim();
  const file=$('#bFoto').files[0]; let foto="";
  if(editBeritaId){
    if(file) foto=await uploadToImgBB(file);
    await updateDoc(doc(db,'berita',editBeritaId),{judul,isi,...(foto&&{foto})});
    alert("Berita diperbarui!"); editBeritaId=null; $('#bBatal').style.display='none';
  }else{
    if(file) foto=await uploadToImgBB(file);
    await addDoc(collection(db,'berita'),{judul,isi,foto,penulis:auth.currentUser?.email||"anonim",createdAt:serverTimestamp()});
    alert("Berita disimpan!");
  }
  $('#bJudul').value=''; $('#bIsi').value=''; $('#bFoto').value=''; loadBerita();
};
$('#bBatal').onclick=()=>{editBeritaId=null;$('#bJudul').value='';$('#bIsi').value='';$('#bFoto').value='';$('#bBatal').style.display='none';};
async function loadBerita(){
  const c=$('#beritaList');
  const snap=await getDocs(query(collection(db,'berita'),orderBy('createdAt','desc')));
  c.innerHTML='';
  snap.forEach(d=>{
    const b=d.data();
    const el=document.createElement('div'); el.className='card';
    el.innerHTML=`${b.foto?`<img src="${b.foto}">`:''}<h3>${b.judul}</h3><p>${b.isi}</p>
    <div class="row"><button class="btn btn-primary" onclick="editBerita('${d.id}')">âœï¸ Edit</button><button class="btn" onclick="hapusBerita('${d.id}')">ğŸ—‘ï¸ Hapus</button></div>`;
    c.appendChild(el);
  });
}
window.editBerita=async(id)=>{const ds=await getDoc(doc(db,'berita',id));const v=ds.data();$('#bJudul').value=v.judul;$('#bIsi').value=v.isi;editBeritaId=id;$('#bBatal').style.display='inline-block';};
window.hapusBerita=async(id)=>{if(!confirm("Hapus?"))return;await deleteDoc(doc(db,'berita',id));loadBerita();};

/* ===== UMKM ===== */
let editUmkmId=null;
$('#uSimpan').onclick=async()=>{
  const nama=$('#uNama').value.trim(),harga=Number($('#uHarga').value||0),wa=$('#uWa').value.trim(),des=$('#uDes').value.trim(),file=$('#uFoto').files[0];
  let foto=""; if(editUmkmId){if(file)foto=await uploadToImgBB(file);await updateDoc(doc(db,'umkm',editUmkmId),{nama,harga,wa,deskripsi:des,...(foto&&{foto})});alert("UMKM diperbarui!");editUmkmId=null;$('#uBatal').style.display='none';}
  else{if(file)foto=await uploadToImgBB(file);await addDoc(collection(db,'umkm'),{nama,harga,wa,deskripsi:des,foto,createdAt:serverTimestamp()});alert("UMKM disimpan!");}
  $('#uNama').value='';$('#uHarga').value='';$('#uWa').value='';$('#uDes').value='';$('#uFoto').value='';loadUmkm();
};
$('#uBatal').onclick=()=>{editUmkmId=null;$('#uNama').value='';$('#uHarga').value='';$('#uWa').value='';$('#uDes').value='';$('#uFoto').value='';$('#uBatal').style.display='none';};
async function loadUmkm(){
  const c=$('#umkmList');const snap=await getDocs(query(collection(db,'umkm'),orderBy('createdAt','desc')));c.innerHTML='';
  snap.forEach(d=>{const u=d.data();const el=document.createElement('div');el.className='card';
  el.innerHTML=`${u.foto?`<img src="${u.foto}">`:''}<h3>${u.nama}</h3><p>ğŸ’° Rp${(u.harga||0).toLocaleString()}</p><p>${u.deskripsi||''}</p><p>ğŸ“± <a href="https://wa.me/${u.wa}" target="_blank">${u.wa}</a></p>
  <div class="row"><button class="btn btn-primary" onclick="editUmkm('${d.id}')">âœï¸ Edit</button><button class="btn" onclick="hapusUmkm('${d.id}')">ğŸ—‘ï¸ Hapus</button></div>`;c.appendChild(el);});
}
window.editUmkm=async(id)=>{const ds=await getDoc(doc(db,'umkm',id));const v=ds.data();$('#uNama').